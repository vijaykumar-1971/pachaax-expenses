<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pachaax Expenses</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#fff7ed;min-height:100vh;padding-bottom:60px}
.header{background:linear-gradient(90deg,#d97706,#ea580c);color:white;padding:16px}
.header h1{font-size:22px;font-weight:900}
.header p{font-size:11px;color:#fef3c7;margin-top:2px}
.header-row{display:flex;justify-content:space-between;align-items:center}
.tabs{display:flex;background:white;box-shadow:0 2px 4px rgba(0,0,0,0.1);position:sticky;top:0;z-index:100}
.tab{flex:1;padding:12px 2px;font-size:10px;font-weight:700;text-transform:uppercase;background:none;border:none;cursor:pointer;color:#6b7280;border-bottom:3px solid transparent}
.tab.active{color:#92400e;background:#fef3c7;border-bottom:3px solid #d97706}
.content{max-width:600px;margin:0 auto;padding:16px}
.card{background:white;border-radius:14px;padding:16px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);border:2px solid #fed7aa}
.row{display:flex;justify-content:space-between;align-items:flex-start}
.tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;padding-top:8px;border-top:1px solid #f3f4f6}
.tag{background:#fef3c7;color:#92400e;padding:3px 10px;border-radius:20px;font-size:12px;font-weight:700}
.btn{padding:10px 16px;border-radius:10px;font-weight:700;font-size:13px;cursor:pointer;border:none}
.btn-primary{background:linear-gradient(90deg,#d97706,#ea580c);color:white}
.btn-primary:disabled{opacity:0.5;cursor:not-allowed}
.btn-secondary{background:#e5e7eb;color:#374151}
.btn-red{background:#ef4444;color:white}
.btn-green{background:#16a34a;color:white}
.btn-purple{background:linear-gradient(90deg,#7c3aed,#4f46e5);color:white;text-decoration:none;display:inline-block;text-align:center}
.btn-sm{padding:8px 12px;font-size:12px;border-radius:8px}
.sec-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.sec-header h2{font-size:20px;font-weight:900;color:#1f2937}
.empty{background:white;border-radius:14px;padding:40px;text-align:center}
.empty p{color:#6b7280;font-size:15px;margin-bottom:16px}
.avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#fbbf24,#f97316);color:white;font-size:18px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;padding:16px;z-index:999}
.modal{background:white;border-radius:20px;padding:24px;width:100%;max-width:400px;max-height:90vh;overflow-y:auto}
.modal h3{font-size:20px;font-weight:900;margin-bottom:16px;color:#1f2937}
.field{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:10px;font-size:15px;margin-bottom:10px;outline:none;font-family:inherit;background:white;display:block}
.field:focus{border-color:#d97706}
.modal-btns{display:flex;gap:10px;margin-top:8px}
.modal-btns .btn{flex:1;padding:12px}
.split-toggle{display:flex;gap:8px;margin-bottom:10px}
.split-toggle .btn{flex:1;padding:9px;font-size:12px}
.custom-box{background:#f9fafb;border-radius:10px;padding:12px;margin-bottom:10px;border:2px solid #e5e7eb}
.custom-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.custom-row span{flex:1;font-weight:600;font-size:14px}
.custom-input{width:100px;padding:9px;font-size:14px;border:2px solid #e5e7eb;border-radius:8px;outline:none;font-family:inherit}
.custom-input:focus{border-color:#d97706}
.custom-total{display:flex;justify-content:space-between;padding-top:8px;margin-top:4px;border-top:1px solid #e5e7eb;font-size:13px}
.bal-table{background:white;border-radius:12px;padding:16px;margin-bottom:14px;box-shadow:0 2px 6px rgba(0,0,0,0.07)}
.bal-row{display:flex;justify-content:space-between;padding:9px 0;border-bottom:1px solid #f3f4f6}
.bal-row:last-child{border:none}
.green-box{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border-radius:14px;padding:16px;border:2px solid #86efac}
.green-box h3{font-weight:900;font-size:15px;color:#14532d;margin-bottom:12px;text-transform:uppercase}
.settle-card{background:white;border-radius:10px;padding:14px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,0.08)}
.settle-card.paid{background:#f3f4f6;opacity:0.6}
.settle-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.settle-btns{display:flex;gap:8px}
.thai-card{background:linear-gradient(135deg,#eff6ff,#f5f3ff);border-radius:14px;padding:20px;margin-bottom:12px;border:2px solid #ddd6fe}
.checklist label{display:flex;align-items:center;gap:10px;padding:7px;border-radius:8px;cursor:pointer;font-size:14px}
.checklist label:hover{background:#f0fdf4}
.checklist input[type=checkbox]{width:17px;height:17px;flex-shrink:0}
.footer{position:fixed;bottom:0;left:0;right:0;background:#78350f;color:#fef3c7;padding:7px;text-align:center;font-size:11px}
.del-btn{background:none;border:none;cursor:pointer;color:#ef4444;padding:4px;font-size:18px}
.refresh-btn{background:rgba(0,0,0,0.2);color:white;border:none;padding:7px 12px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer}
.loading{display:flex;align-items:center;justify-content:center;min-height:80vh;flex-direction:column;gap:8px;text-align:center}
.pos{color:#16a34a;font-weight:700;font-size:13px}
.neg{color:#ef4444;font-weight:700;font-size:13px}
.zero{color:#6b7280;font-weight:700;font-size:13px}
.friend-card{background:white;border-radius:14px;padding:14px;margin-bottom:10px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 8px rgba(0,0,0,0.07);border:2px solid #fed7aa}
.toast{position:fixed;top:16px;left:50%;transform:translateX(-50%);background:#1f2937;color:white;padding:10px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;opacity:0;transition:opacity 0.3s}
.toast.show{opacity:1}
</style>
</head>
<body>
<div id="app">
  <div class="loading">
    <h2 style="color:#d97706;font-size:22px">Loading Pachaax...</h2>
    <p style="color:#6b7280">‚òÅÔ∏è Connecting to Firebase</p>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
// ===== PASSWORD =====
const APP_PASSWORD = 'pachaax2025';
let UNLOCKED = true; // Password disabled

// ===== FIREBASE CONFIG =====
const FB_BASE = 'https://pachaax-expenses-default-rtdb.firebaseio.com/trips';
let TRIP_ID   = localStorage.getItem('pachaax-trip') || '';
let ALL_TRIPS = [];
function FB()      { return FB_BASE + '/' + TRIP_ID + '.json'; }
function FB_ALL()  { return FB_BASE + '.json?shallow=true'; }
function FB_META() { return FB_BASE + '/' + TRIP_ID + '/meta.json'; }

// ===== FETCH WITH TIMEOUT =====
async function fetchWithTimeout(url, options={}, ms=8000) {
  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), ms);
  try {
    const r = await fetch(url, {...options, signal: controller.signal});
    clearTimeout(timer);
    return r;
  } catch(e) {
    clearTimeout(timer);
    throw e;
  }
}

// ===== STATE =====
let DB = { friends:[], expenses:[], settlements:[], meta:{} };
let UI = { tab:'expenses', syncing:false, lastSync:null, loading:true, showTrip: !TRIP_ID, loadingTrips:false };
let M = { type:null, fname:'', edesc:'', eamt:'', epayer:'', esplit:'equal', csplits:{}, editId:null };

// ===== TOAST =====
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// ===== FIREBASE API =====
async function loadDB() {
  if (!TRIP_ID) {
    UI.loading = false;
    UI.showTrip = true;
    renderApp();
    loadAllTrips();
    return;
  }
  UI.loading = true;
  renderApp();
  try {
    const r = await fetchWithTimeout(FB());
    if (r.ok) {
      const d = await r.json();
      if (d) {
        DB.friends     = d.friends     || [];
        DB.expenses    = d.expenses    || [];
        DB.settlements = d.settlements || [];
        DB.meta        = d.meta        || {};
      } else {
        DB = { friends:[], expenses:[], settlements:[], meta:{} };
      }
      UI.lastSync = new Date().toLocaleTimeString();
    } else {
      toast('‚ö†Ô∏è Server error: ' + r.status);
    }
  } catch(e) {
    toast('‚ö†Ô∏è Could not connect. Check internet or Firebase rules.');
    console.error(e);
  }
  UI.loading = false;
  renderApp();
}

async function loadAllTrips() {
  try {
    const r = await fetchWithTimeout(FB_ALL(), {}, 6000);
    if (r.ok) {
      const d = await r.json();
      if (d) {
        const keys = Object.keys(d);
        const metas = await Promise.all(keys.map(async k => {
          try {
            const mr = await fetchWithTimeout(FB_BASE + '/' + k + '/meta.json', {}, 5000);
            const m  = mr.ok ? await mr.json() : null;
            return { id: k, name: m?.name || k, date: m?.date || '' };
          } catch(e) { return { id: k, name: k, date: '' }; }
        }));
        ALL_TRIPS = metas.sort((a,b) => b.date.localeCompare(a.date));
      } else {
        ALL_TRIPS = [];
      }
    }
  } catch(e) { ALL_TRIPS = []; }
  UI.loadingTrips = false;
  renderApp();
}

async function saveDB() {
  UI.syncing = true; updateStatus();
  try {
    const r = await fetchWithTimeout(FB(), {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(DB)
    });
    if (r.ok) {
      UI.lastSync = new Date().toLocaleTimeString();
      toast('‚úÖ Saved & synced!');
    } else {
      toast('‚ö†Ô∏è Save failed: ' + r.status);
    }
  } catch(e) { toast('‚ö†Ô∏è No internet or request timed out.'); }
  UI.syncing = false; updateStatus();
}

function updateStatus() {
  const el = document.getElementById('sync-status');
  if (el) el.textContent = UI.syncing ? '‚òÅÔ∏è Syncing...' : UI.lastSync ? '‚úÖ Synced: '+UI.lastSync : '';
}

// ===== AUTO REFRESH =====
setInterval(async () => {
  if (M.type || !TRIP_ID || UI.syncing) return;
  try {
    const r = await fetchWithTimeout(FB(), {}, 6000);
    if (r.ok) {
      const d = await r.json();
      if (d) {
        DB.friends=d.friends||[]; DB.expenses=d.expenses||[]; DB.settlements=d.settlements||[]; DB.meta=d.meta||{};
        UI.lastSync=new Date().toLocaleTimeString();
        renderApp();
      }
    }
  } catch(e) {}
}, 10000);

// ===== TRIP MANAGEMENT =====
async function checkPassword() {
  const val = document.getElementById('inp-password') ? document.getElementById('inp-password').value : '';
  if (val === APP_PASSWORD) {
    UNLOCKED = true;
    localStorage.setItem('pachaax-auth', APP_PASSWORD);
    loadAllTrips();
    renderApp();
  } else {
    document.getElementById('pwd-error').style.display = 'block';
    document.getElementById('inp-password').value = '';
    document.getElementById('inp-password').focus();
  }
}

function logout() {
  UNLOCKED = false;
  localStorage.removeItem('pachaax-auth');
  TRIP_ID = '';
  localStorage.removeItem('pachaax-trip');
  DB = { friends:[], expenses:[], settlements:[], meta:{} };
  ALL_TRIPS = [];
  UI.showTrip = true;
  renderApp();
}

function passwordScreen() {
  return `
  <div style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;background:linear-gradient(135deg,#1e1b4b,#312e81,#4c1d95)">
    <div style="font-size:56px;margin-bottom:16px">üîê</div>
    <h1 style="font-size:26px;font-weight:900;color:white;margin-bottom:6px">Pachaax Expenses</h1>
    <p style="color:#c4b5fd;font-size:13px;margin-bottom:28px;text-align:center">Private group expense tracker.<br>Enter password to continue.</p>
    <div style="background:white;border-radius:20px;padding:28px;width:100%;max-width:360px;box-shadow:0 8px 32px rgba(0,0,0,0.3)">
      <label style="font-size:12px;font-weight:700;color:#374151;display:block;margin-bottom:6px;text-transform:uppercase">Password</label>
      <input id="inp-password" class="field" type="password" placeholder="Enter password"
        onkeydown="if(event.key==='Enter')checkPassword()" autofocus
        style="letter-spacing:2px;font-size:18px">
      <div id="pwd-error" style="display:none;color:#ef4444;font-size:13px;font-weight:600;margin-bottom:10px;text-align:center">
        ‚ùå Wrong password! Try again.
      </div>
      <button class="btn btn-primary" onclick="checkPassword()" style="width:100%;padding:14px;font-size:15px">
        üîì Unlock App
      </button>
      <p style="text-align:center;color:#9ca3af;font-size:11px;margin-top:16px">
        Contact your group admin for the password.
      </p>
    </div>
  </div>`;
}

function setTrip() {
  const nameVal = document.getElementById('inp-trip') ? document.getElementById('inp-trip').value.trim() : '';
  const dateVal = document.getElementById('inp-date') ? document.getElementById('inp-date').value : '';
  if (!nameVal) { toast('Enter a Trip Name!'); return; }
  // Generate ID from name
  TRIP_ID = nameVal.toUpperCase().replace(/\s+/g,'-').replace(/[^A-Z0-9-]/g,'');
  localStorage.setItem('pachaax-trip', TRIP_ID);
  DB = { friends:[], expenses:[], settlements:[], meta:{ name: nameVal, date: dateVal, created: new Date().toISOString() } };
  UI.showTrip = false; UI.loading = true;
  renderApp();
  // Save meta first, then load
  await fetch(FB_META(), { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(DB.meta) });
  loadDB();
}

function selectTrip(id) {
  TRIP_ID = id;
  localStorage.setItem('pachaax-trip', TRIP_ID);
  DB = { friends:[], expenses:[], settlements:[], meta:{} };
  UI.showTrip = false; UI.loading = true;
  renderApp(); loadDB();
}

function switchTrip() {
  TRIP_ID = '';
  localStorage.removeItem('pachaax-trip');
  DB = { friends:[], expenses:[], settlements:[], meta:{} };
  ALL_TRIPS = [];
  UI.showTrip = true; UI.loading = false;
  loadAllTrips();
  renderApp();
}

// ===== CALCULATIONS =====
function getBalances() {
  const b = {};
  DB.friends.forEach(f => b[f.id] = 0);
  DB.expenses.forEach(e => {
    b[e.paidBy] = (b[e.paidBy]||0) + e.amount;
    Object.entries(e.splitAmong).forEach(([id,a]) => b[id] = (b[id]||0) - a);
  });
  return b;
}

function getSettlements() {
  const b = getBalances();
  const debt=[], cred=[], res=[];
  Object.entries(b).forEach(([id,v]) => {
    if (v<-0.01) debt.push({id,a:-v});
    else if (v>0.01) cred.push({id,a:v});
  });
  let i=0,j=0;
  while(i<debt.length && j<cred.length){
    const d=debt[i],c=cred[j],amt=Math.min(d.a,c.a),key=d.id+'-'+c.id;
    res.push({from:d.id,to:c.id,amount:amt,key,paid:DB.settlements.includes(key)});
    d.a-=amt; c.a-=amt;
    if(d.a<0.01)i++; if(c.a<0.01)j++;
  }
  return res;
}

function getName(id){ return (DB.friends.find(f=>f.id===id)||{name:'?'}).name; }
function upiLink(n,a){ return 'upi://pay?pn='+encodeURIComponent(n)+'&am='+Math.round(a)+'&cu=INR&tn=Pachaax'; }
function cTotal(){ return Object.values(M.csplits).reduce((s,v)=>s+(parseFloat(v)||0),0); }

// ===== ACTIONS =====
async function addFriend() {
  const n = document.getElementById('inp-fname') ? document.getElementById('inp-fname').value.trim() : M.fname.trim();
  if (!n) { toast('Enter a name!'); return; }
  DB.friends.push({id:'f'+Date.now(), name:n});
  M.type=null; M.fname='';
  renderApp(); await saveDB();
}

async function addExpense() {
  const desc  = document.getElementById('inp-edesc').value.trim();
  const amt   = parseFloat(document.getElementById('inp-eamt').value);
  const payer = document.getElementById('inp-epayer').value;
  if (!desc || isNaN(amt) || amt<=0 || !payer) { toast('Fill in all fields!'); return; }
  const split = {};
  if (M.esplit==='equal') {
    const per = amt/DB.friends.length;
    DB.friends.forEach(f => split[f.id]=per);
  } else {
    DB.friends.forEach(f => {
      const el = document.getElementById('cs-'+f.id);
      M.csplits[f.id] = el ? el.value : (M.csplits[f.id]||0);
    });
    const tot = cTotal();
    if (Math.abs(tot-amt)>0.01) { toast('Split ‚Çπ'+Math.round(tot)+' ‚â† ‚Çπ'+Math.round(amt)); return; }
    DB.friends.forEach(f => split[f.id]=parseFloat(M.csplits[f.id])||0);
  }

  if (M.editId) {
    // Edit existing expense
    const idx = DB.expenses.findIndex(e => e.id === M.editId);
    if (idx !== -1) {
      DB.expenses[idx] = { ...DB.expenses[idx], description:desc, amount:amt, paidBy:payer, splitAmong:split };
    }
  } else {
    // Add new expense
    DB.expenses.push({ id:'e'+Date.now(), description:desc, amount:amt, paidBy:payer, splitAmong:split, date:new Date().toISOString() });
  }

  M.type=null; M.edesc=''; M.eamt=''; M.epayer=''; M.esplit='equal'; M.csplits={}; M.editId=null;
  renderApp(); await saveDB();
}

function editExpense(id) {
  const e = DB.expenses.find(ex => ex.id === id);
  if (!e) return;
  M.type   = 'expense';
  M.editId = id;
  M.edesc  = e.description;
  M.eamt   = String(e.amount);
  M.epayer = e.paidBy;
  const vals = Object.values(e.splitAmong);
  const allEqual = vals.length > 1 && vals.every(v => Math.abs(v - vals[0]) < 0.01);
  M.esplit  = allEqual ? 'equal' : 'custom';
  M.csplits = allEqual ? {} : Object.fromEntries(Object.entries(e.splitAmong).map(([k,v])=>[k,String(v)]));
  renderApp();
  setTimeout(() => {
    const el = document.getElementById('inp-edesc');
    if (el) { el.focus(); el.setSelectionRange(el.value.length, el.value.length); }
    if (M.esplit === 'custom') updateCustomTotal();
  }, 100);
}

async function delExpense(id) {
  if (!confirm('Delete this expense?')) return;
  DB.expenses = DB.expenses.filter(e=>e.id!==id);
  renderApp(); await saveDB();
}

async function markPaid(key,paid) {
  if(paid) DB.settlements.push(key);
  else DB.settlements = DB.settlements.filter(s=>s!==key);
  renderApp(); await saveDB();
}

async function resetAll() {
  if (!confirm('‚ö†Ô∏è Delete ALL data for everyone? Cannot be undone!')) return;
  DB={friends:[],expenses:[],settlements:[]};
  renderApp(); await saveDB();
}

// ===== UI CONTROLS =====
function setTab(t) {
  UI.tab=t; renderApp();
}
function openFriend()  { M.type='friend'; renderApp(); setTimeout(()=>{ const el=document.getElementById('inp-fname'); if(el)el.focus(); },100); }
function openExpense() { M.type='expense'; M.editId=null; M.edesc=''; M.eamt=''; M.epayer=''; M.esplit='equal'; M.csplits={}; renderApp(); setTimeout(()=>{ const el=document.getElementById('inp-edesc'); if(el)el.focus(); },100); }
function closeModal()  { M.type=null; M.editId=null; renderApp(); }
function setSplit(t)   { M.esplit=t; renderApp(); setTimeout(()=>{ const el=document.getElementById('inp-edesc'); if(el)el.focus(); },10); }

function updateCustomTotal() {
  let total = 0;
  DB.friends.forEach(f => {
    const el = document.getElementById('cs-'+f.id);
    if (el) total += parseFloat(el.value)||0;
  });
  const display = document.getElementById('ct-display');
  const amtEl   = document.getElementById('inp-eamt');
  const target  = parseFloat(amtEl ? amtEl.value : 0)||0;
  const match   = target > 0 && Math.abs(total - target) < 0.01;
  if (display) {
    display.textContent = '‚Çπ'+Math.round(total) + (match ? ' ‚úÖ' : (target>0?' ‚Üê need ‚Çπ'+Math.round(target):''));
    display.style.color = match ? '#16a34a' : '#ef4444';
  }
}
function refreshNow()  { UI.loading=true; renderApp(); loadDB(); }

// ===== RENDER =====
function renderApp() {
  const app = document.getElementById('app');
  if (!app) return;

  let body = '';
  if (!UNLOCKED) { app.innerHTML = passwordScreen(); return; }
  if (UI.loading) {
    body = `<div class="loading"><h2 style="color:#d97706">Loading...</h2><p style="color:#6b7280">‚òÅÔ∏è Syncing</p></div>`;
  } else if (UI.tab==='expenses') body = tabExpenses();
  else if (UI.tab==='friends')    body = tabFriends();
  else if (UI.tab==='settle')     body = tabSettle();
  else if (UI.tab==='thailand')   body = tabThailand();

  app.innerHTML = `
  ${UI.showTrip ? tripScreen() : `
  <div class="header">
    <div class="header-row">
      <div>
        <h1>üí∞ Pachaax Expenses</h1>
        <p id="sync-status">${UI.syncing?'‚òÅÔ∏è Syncing...':UI.lastSync?'‚úÖ Synced: '+UI.lastSync:'Real-time shared tracker'}</p>
        ${DB.meta?.name ? `<p style="font-size:12px;color:#fef3c7;font-weight:700;margin-top:2px">‚úàÔ∏è ${DB.meta.name}${DB.meta.date?' &nbsp;|&nbsp; üìÖ '+new Date(DB.meta.date).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}):''}</p>` : ''}
      </div>
      <div style="display:flex;gap:6px;align-items:center">
        <div style="background:rgba(0,0,0,0.2);padding:5px 8px;border-radius:8px;font-size:11px;font-weight:700;color:white">
          üè∑Ô∏è ${TRIP_ID}
        </div>
        <button class="refresh-btn" onclick="refreshNow()">üîÑ</button>
        <button class="refresh-btn" onclick="switchTrip()" title="Switch Trip">üîÄ</button>
        <button class="refresh-btn" onclick="logout()" title="Logout">üîí</button>
      </div>
    </div>
  </div>
  <div class="tabs">
    <button class="tab ${UI.tab==='expenses'?'active':''}" onclick="setTab('expenses')">Expenses</button>
    <button class="tab ${UI.tab==='friends'?'active':''}" onclick="setTab('friends')">Friends (${DB.friends.length})</button>
    <button class="tab ${UI.tab==='settle'?'active':''}" onclick="setTab('settle')">Settle Up</button>
    <button class="tab ${UI.tab==='thailand'?'active':''}" onclick="setTab('thailand')">Ravi's Thai üáπüá≠</button>
  </div>
  <div class="content">${body}</div>
  ${M.type==='friend' ? modalFriend() : M.type==='expense' ? modalExpense() : ''}
  <div class="footer">üí° Trip: ${TRIP_ID} | Syncs every 10s across all devices!</div>
  `}
  `;
}

// ===== TABS =====
function tripScreen() {
  const today = new Date().toISOString().split('T')[0];
  const tripList = ALL_TRIPS.length ? `
    <div style="margin-top:20px">
      <div style="font-weight:700;font-size:13px;color:#374151;margin-bottom:8px">üìã OR JOIN EXISTING TRIP</div>
      <div style="display:flex;flex-direction:column;gap:8px;max-height:220px;overflow-y:auto">
        ${ALL_TRIPS.map(t => `
        <div onclick="selectTrip('${t.id}')" style="background:#fff7ed;border:2px solid #fed7aa;border-radius:12px;padding:12px 14px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:all 0.2s"
          onmouseover="this.style.background='#fef3c7'" onmouseout="this.style.background='#fff7ed'">
          <div>
            <div style="font-weight:900;font-size:14px;color:#92400e">${t.name}</div>
            <div style="font-size:11px;color:#6b7280;margin-top:2px">
              üè∑Ô∏è ${t.id} ${t.date ? '&nbsp;|&nbsp; üìÖ '+new Date(t.date).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}) : ''}
            </div>
          </div>
          <div style="font-size:20px">‚Üí</div>
        </div>`).join('')}
      </div>
    </div>` : UI.loadingTrips ? `<div style="text-align:center;color:#6b7280;font-size:13px;margin-top:16px">‚è≥ Loading trips...</div>` : `<div style="text-align:center;color:#6b7280;font-size:13px;margin-top:16px">No existing trips found.</div>`;

  return `
  <div style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;background:linear-gradient(135deg,#fff7ed,#fef3c7)">
    <div style="font-size:48px;margin-bottom:12px">üí∞</div>
    <h1 style="font-size:26px;font-weight:900;color:#92400e;margin-bottom:4px">Pachaax Expenses</h1>
    <p style="color:#6b7280;font-size:13px;margin-bottom:24px;text-align:center">Create a new trip or join an existing one</p>
    <div style="background:white;border-radius:20px;padding:24px;width:100%;max-width:380px;box-shadow:0 4px 20px rgba(0,0,0,0.1)">
      <div style="font-weight:700;font-size:13px;color:#374151;margin-bottom:8px">‚ú® CREATE NEW TRIP</div>
      <label style="font-size:12px;color:#6b7280;display:block;margin-bottom:4px">Trip Name</label>
      <input id="inp-trip" class="field" type="text" placeholder="e.g. Thailand 2025, Goa Trip"
        onkeydown="if(event.key==='Enter')setTrip()">
      <label style="font-size:12px;color:#6b7280;display:block;margin-bottom:4px">Trip Date</label>
      <input id="inp-date" class="field" type="date" value="${today}">
      <button class="btn btn-primary" onclick="setTrip()" style="width:100%;padding:13px;font-size:15px;margin-top:4px">
        üöÄ Create Trip
      </button>
      ${tripList}
    </div>
  </div>`;
}

function tabExpenses() {
  let h=`<div class="sec-header"><h2>All Expenses</h2>
    <button class="btn btn-primary" onclick="openExpense()" ${!DB.friends.length?'disabled':''}>+ Add</button></div>`;
  if (!DB.friends.length) return h+`<div class="empty"><p>üë• Add friends first!</p><button class="btn btn-primary" onclick="setTab('friends')">Go to Friends</button></div>`;
  if (!DB.expenses.length) return h+`<div class="empty"><p>üí∏ No expenses yet!</p></div>`;
  const grandTotal = DB.expenses.reduce((s,e)=>s+e.amount,0);
  h+=`<div style="background:linear-gradient(90deg,#d97706,#ea580c);color:white;border-radius:14px;padding:14px 16px;margin-bottom:14px;display:flex;justify-content:space-between;align-items:center">
    <div>
      <div style="font-size:12px;font-weight:700;opacity:0.85;text-transform:uppercase">Total Expenses</div>
      <div style="font-size:11px;opacity:0.75">${DB.expenses.length} expense${DB.expenses.length!==1?'s':''} across ${DB.friends.length} people</div>
    </div>
    <div style="font-size:26px;font-weight:900">‚Çπ${Math.round(grandTotal).toLocaleString()}</div>
  </div>`;
  return h+DB.expenses.map(e=>{
    const tags=Object.entries(e.splitAmong).filter(([,a])=>a>0)
      .map(([id,a])=>`<span class="tag">${getName(id)}: ‚Çπ${Math.round(a)}</span>`).join('');
    return `<div class="card">
      <div class="row">
        <div style="flex:1">
          <div style="font-weight:900;font-size:16px">${e.description}</div>
          <div style="font-size:12px;color:#6b7280;margin-top:2px">Paid by <strong style="color:#d97706">${getName(e.paidBy)}</strong></div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <div style="font-size:20px;font-weight:900;color:#d97706">‚Çπ${Math.round(e.amount)}</div>
          <button class="del-btn" onclick="editExpense('${e.id}')" title="Edit" style="color:#d97706;font-size:16px">‚úèÔ∏è</button>
          <button class="del-btn" onclick="delExpense('${e.id}')">‚úï</button>
        </div>
      </div>
      <div class="tags">${tags}</div>
    </div>`;
  }).join('');
}

function tabFriends() {
  const bal=getBalances();
  let h=`<div class="sec-header"><h2>Your Group</h2>
    <button class="btn btn-primary" onclick="openFriend()">+ Add</button></div>`;
  if (!DB.friends.length) return h+`<div class="empty"><p>üë• Add your travel buddies!</p></div>`;
  h+=DB.friends.map(f=>{
    const b=bal[f.id]||0,cls=b>0.01?'pos':b<-0.01?'neg':'zero';
    const txt=b>0.01?`Gets back ‚Çπ${Math.round(b)}`:b<-0.01?`Owes ‚Çπ${Math.round(-b)}`:'All settled ‚úì';
    return `<div class="friend-card">
      <div class="avatar">${f.name[0].toUpperCase()}</div>
      <div><div style="font-weight:900;font-size:16px">${f.name}</div>
      <div class="${cls}">${txt}</div></div></div>`;
  }).join('');
  h+=`<div style="text-align:center;margin-top:12px">
    <button class="btn btn-red btn-sm" onclick="resetAll()">üóëÔ∏è Reset All Data</button></div>`;
  return h;
}

function tabSettle() {
  if (!DB.friends.length) return `<div class="empty"><p>Add friends first!</p></div>`;
  if (!DB.expenses.length) return `<div class="empty"><p>No expenses to settle yet!</p></div>`;
  const bal=getBalances(), sets=getSettlements();
  let h=`<div class="bal-table"><div style="font-weight:900;font-size:16px;margin-bottom:10px">Current Balances</div>`;
  h+=DB.friends.map(f=>{
    const b=bal[f.id]||0,cls=b>0.01?'pos':b<-0.01?'neg':'zero';
    const txt=b>0.01?`+‚Çπ${Math.round(b)}`:b<-0.01?`-‚Çπ${Math.round(-b)}`:'‚Çπ0';
    return `<div class="bal-row"><span style="font-weight:700">${f.name}</span><span class="${cls}">${txt}</span></div>`;
  }).join('');
  h+=`</div><div class="green-box"><h3>üí≥ Payments to Make</h3>`;
  if (!sets.length) {
    h+=`<p style="text-align:center;color:#16a34a;font-weight:700;padding:16px">üéâ All settled up!</p>`;
  } else {
    h+=sets.map(s=>`
    <div class="settle-card ${s.paid?'paid':''}">
      <div class="settle-row">
        <div style="font-weight:700;font-size:14px">${getName(s.from)} ‚Üí ${getName(s.to)}</div>
        <div style="font-weight:900;font-size:18px;color:${s.paid?'#6b7280':'#16a34a'}">‚Çπ${Math.round(s.amount)}</div>
      </div>
      <div class="settle-btns">
        ${s.paid
          ?`<button class="btn btn-secondary btn-sm" onclick="markPaid('${s.key}',false)" style="width:100%">‚úì Paid ‚Äî Tap to undo</button>`
          :`<a href="${upiLink(getName(s.to),s.amount)}" class="btn btn-purple btn-sm" style="flex:1">üí≥ Pay UPI</a>
            <button class="btn btn-green btn-sm" onclick="markPaid('${s.key}',true)" style="flex:1">Mark Paid</button>`
        }
      </div>
    </div>`).join('');
  }
  return h+`</div>`;
}

function tabThailand(){
  return `
  <div class="thai-card">
    <h2 style="font-size:20px;font-weight:900;margin-bottom:14px">Ravi's Dream Thai Trip üáπüá≠</h2>
    <h3 style="font-weight:900;margin-bottom:10px">‚úàÔ∏è Must-Visit Places</h3>
    <ul style="list-style:none">
      <li style="padding:6px 0">üèØ <strong>Bangkok</strong> ‚Äî Grand Palace, street food</li>
      <li style="padding:6px 0">üèùÔ∏è <strong>Phuket</strong> ‚Äî Beaches & islands</li>
      <li style="padding:6px 0">üåÑ <strong>Chiang Mai</strong> ‚Äî Temples, night markets</li>
      <li style="padding:6px 0">üèñÔ∏è <strong>Krabi</strong> ‚Äî Cliffs & clear waters</li>
    </ul>
  </div>
  <div class="thai-card">
    <h3 style="font-weight:900;margin-bottom:12px">‚úÖ Trip Checklist</h3>
    <div class="checklist">
      <label><input type="checkbox"> Check passport validity (6+ months)</label>
      <label><input type="checkbox"> Get travel insurance</label>
      <label><input type="checkbox"> Book flights & accommodation</label>
      <label><input type="checkbox"> Notify bank about travel dates</label>
      <label><input type="checkbox"> Exchange currency to Thai Baht</label>
      <label><input type="checkbox"> Pack sunscreen & medications</label>
      <label><input type="checkbox"> Download offline maps</label>
      <label><input type="checkbox"> Set up Pachaax expense tracker! üí∞</label>
    </div>
  </div>`;
}

// ===== MODALS =====
function modalFriend(){
  return `<div class="modal-bg" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <h3>üë§ Add Friend</h3>
      <input id="inp-fname" class="field" type="text" placeholder="Friend's name" autocomplete="off"
        onkeydown="if(event.key==='Enter')addFriend()">
      <div class="modal-btns">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="addFriend()">Add Friend</button>
      </div>
    </div>
  </div>`;
}

function modalExpense(){
  const opts = DB.friends.map(f =>
    `<option value="${f.id}" ${M.epayer === f.id ? 'selected' : ''}>${f.name}</option>`
  ).join('');
  const ea = parseFloat(M.eamt)||0;
  const isEdit = !!M.editId;

  const customBox = M.esplit==='custom' ? `
    <div class="custom-box">
      <div style="font-size:12px;font-weight:700;color:#6b7280;margin-bottom:8px">AMOUNT PER PERSON:</div>
      ${DB.friends.map(f=>`
      <div class="custom-row">
        <span>${f.name}</span>
        <input id="cs-${f.id}" class="custom-input" type="number" inputmode="decimal"
          placeholder="0" value="${M.csplits[f.id]||''}"
          oninput="updateCustomTotal()">
      </div>`).join('')}
      <div class="custom-total">
        <span style="font-weight:700">Total:</span>
        <span id="ct-display" style="font-weight:900;color:#ef4444">‚Çπ0</span>
      </div>
    </div>` : '';

  return `<div class="modal-bg" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <h3>${isEdit ? '‚úèÔ∏è Edit Expense' : 'üí∏ Add Expense'}</h3>
      <label style="font-size:12px;color:#6b7280;display:block;margin-bottom:4px">Description</label>
      <input id="inp-edesc" class="field" type="text" placeholder="e.g. Dinner, Hotel" autocomplete="off"
        value="${M.edesc}">
      <label style="font-size:12px;color:#6b7280;display:block;margin-bottom:4px">Amount (‚Çπ)</label>
      <input id="inp-eamt" class="field" type="number" inputmode="decimal" placeholder="0"
        value="${M.eamt}" oninput="updateCustomTotal()">
      <label style="font-size:12px;color:#6b7280;display:block;margin-bottom:4px">Who paid?</label>
      <select id="inp-epayer" class="field">
        <option value="">Select person</option>${opts}
      </select>
      <label style="font-size:12px;color:#6b7280;display:block;margin-bottom:6px">Split Type</label>
      <div class="split-toggle">
        <button class="btn btn-sm ${M.esplit==='equal'?'btn-primary':'btn-secondary'}" onclick="setSplit('equal')">‚öñÔ∏è Equal Split</button>
        <button class="btn btn-sm ${M.esplit==='custom'?'btn-primary':'btn-secondary'}" onclick="setSplit('custom')">‚úèÔ∏è Custom Split</button>
      </div>
      ${customBox}
      <div class="modal-btns">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="addExpense()">${isEdit ? 'üíæ Save Changes' : '‚ûï Add Expense'}</button>
      </div>
    </div>
  </div>`;
}

// ===== INIT =====
if (!UNLOCKED) { renderApp(); } else { loadDB(); }
</script>
</body>
</html>
