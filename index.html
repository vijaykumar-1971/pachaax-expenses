<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pachaax Expenses</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#fff7ed;min-height:100vh;padding-bottom:60px}
.header{background:linear-gradient(90deg,#d97706,#ea580c);color:white;padding:16px}
.header h1{font-size:22px;font-weight:900}
.header p{font-size:11px;color:#fef3c7;margin-top:2px}
.header-row{display:flex;justify-content:space-between;align-items:center}
.tabs{display:flex;background:white;box-shadow:0 2px 4px rgba(0,0,0,0.1);position:sticky;top:0;z-index:100;overflow-x:auto}
.tab{flex:1;min-width:80px;padding:12px 4px;font-size:10px;font-weight:700;text-transform:uppercase;background:none;border:none;cursor:pointer;color:#6b7280;border-bottom:3px solid transparent;white-space:nowrap}
.tab.active{color:#92400e;background:#fef3c7;border-bottom:3px solid #d97706}
.content{max-width:600px;margin:0 auto;padding:16px}
.card{background:white;border-radius:14px;padding:16px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);border:2px solid #fed7aa}
.row{display:flex;justify-content:space-between;align-items:flex-start}
.tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;padding-top:8px;border-top:1px solid #f3f4f6}
.tag{background:#fef3c7;color:#92400e;padding:3px 10px;border-radius:20px;font-size:12px;font-weight:700}
.btn{padding:10px 16px;border-radius:10px;font-weight:700;font-size:13px;cursor:pointer;border:none;transition:all 0.2s}
.btn-primary{background:linear-gradient(90deg,#d97706,#ea580c);color:white}
.btn-primary:disabled{opacity:0.5;cursor:not-allowed}
.btn-secondary{background:#e5e7eb;color:#374151}
.btn-red{background:#ef4444;color:white}
.btn-green{background:#16a34a;color:white}
.btn-purple{background:linear-gradient(90deg,#7c3aed,#4f46e5);color:white;text-decoration:none;display:inline-block;text-align:center}
.btn-sm{padding:8px 12px;font-size:12px;border-radius:8px}
.sec-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.sec-header h2{font-size:20px;font-weight:900;color:#1f2937}
.empty{background:white;border-radius:14px;padding:40px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
.empty p{color:#6b7280;font-size:15px;margin-bottom:16px}
.avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#fbbf24,#f97316);color:white;font-size:18px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;padding:16px;z-index:999}
.modal{background:white;border-radius:20px;padding:24px;width:100%;max-width:400px;max-height:90vh;overflow-y:auto}
.modal h3{font-size:20px;font-weight:900;margin-bottom:16px;color:#1f2937}
input,select{width:100%;padding:11px;border:2px solid #e5e7eb;border-radius:10px;font-size:14px;margin-bottom:10px;outline:none;font-family:inherit;background:white}
input:focus,select:focus{border-color:#d97706}
.modal-btns{display:flex;gap:10px;margin-top:6px}
.modal-btns .btn{flex:1;padding:12px}
.split-toggle{display:flex;gap:8px;margin-bottom:10px}
.split-toggle .btn{flex:1;padding:9px;font-size:12px}
.custom-split-box{background:#f9fafb;border-radius:10px;padding:12px;margin-bottom:10px;border:2px solid #e5e7eb}
.custom-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.custom-row label{flex:1;font-weight:600;font-size:13px;color:#374151}
.custom-row input{width:90px;margin:0;padding:8px;font-size:13px;flex-shrink:0}
.custom-total{display:flex;justify-content:space-between;padding-top:8px;margin-top:4px;border-top:1px solid #e5e7eb}
.bal-table{background:white;border-radius:12px;padding:16px;margin-bottom:14px;box-shadow:0 2px 6px rgba(0,0,0,0.07)}
.bal-row{display:flex;justify-content:space-between;padding:9px 0;border-bottom:1px solid #f3f4f6}
.bal-row:last-child{border:none}
.green-box{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border-radius:14px;padding:16px;border:2px solid #86efac}
.green-box h3{font-weight:900;font-size:15px;color:#14532d;margin-bottom:12px;text-transform:uppercase}
.settle-card{background:white;border-radius:10px;padding:14px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,0.08)}
.settle-card.paid{background:#f3f4f6;opacity:0.6}
.settle-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.settle-btns{display:flex;gap:8px}
.thai-card{background:linear-gradient(135deg,#eff6ff,#f5f3ff);border-radius:14px;padding:20px;margin-bottom:12px;border:2px solid #ddd6fe}
.checklist label{display:flex;align-items:center;gap:10px;padding:7px;border-radius:8px;cursor:pointer;font-size:14px}
.checklist label:hover{background:#f0fdf4}
.checklist input[type=checkbox]{width:17px;height:17px;flex-shrink:0}
.footer{position:fixed;bottom:0;left:0;right:0;background:#78350f;color:#fef3c7;padding:7px;text-align:center;font-size:11px}
.del-btn{background:none;border:none;cursor:pointer;color:#ef4444;padding:4px;font-size:16px;line-height:1}
.refresh-btn{background:rgba(0,0,0,0.2);color:white;border:none;padding:7px 12px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer}
.loading{display:flex;align-items:center;justify-content:center;min-height:100vh;flex-direction:column;gap:8px}
.pos{color:#16a34a;font-weight:700;font-size:13px}
.neg{color:#ef4444;font-weight:700;font-size:13px}
.zero{color:#6b7280;font-weight:700;font-size:13px}
.friend-card{background:white;border-radius:14px;padding:14px;margin-bottom:10px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 8px rgba(0,0,0,0.07);border:2px solid #fed7aa}
</style>
</head>
<body>
<div id="app"><div class="loading"><h2 style="color:#d97706">Loading Pachaax...</h2><p style="color:#6b7280">‚òÅÔ∏è Syncing data across all devices</p></div></div>

<script>
// ========== CONFIG ==========
const BIN_ID = '698d6d5ad0ea881f40b411b1';
const API_KEY = '$2a$10$EtNNZ1TPzefvRO2ONkrot.nwo4mTSIbP3677PGGlSZ43vuceHIzWK';
const API_URL = 'https://api.jsonbin.io/v3/b/' + BIN_ID;

// ========== STATE ==========
let S = {
    tab: 'expenses',
    friends: [], expenses: [], settlements: [],
    loading: true, syncing: false, lastSync: null,
    showFriend: false, showExpense: false,
    fname: '',
    edesc: '', eamt: '', epayer: '', esplit: 'equal',
    csplits: {}
};

// ========== API ==========
async function loadData() {
    try {
        const r = await fetch(API_URL + '/latest', {
            headers: {
                'X-Master-Key': API_KEY,
                'X-Bin-Meta': 'false'
            }
        });
        if (r.ok) {
            const d = await r.json();
            S.friends = d.friends || [];
            S.expenses = d.expenses || [];
            S.settlements = d.settlements || [];
            S.lastSync = new Date().toLocaleTimeString();
        }
    } catch(e) { console.error('Load failed:', e); }
    S.loading = false;
    render();
}

async function saveData() {
    S.syncing = true; render();
    try {
        const r = await fetch(API_URL, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-Master-Key': API_KEY
            },
            body: JSON.stringify({
                friends: S.friends,
                expenses: S.expenses,
                settlements: S.settlements
            })
        });
        if (r.ok) S.lastSync = new Date().toLocaleTimeString();
        else alert('Sync failed. Try again.');
    } catch(e) { alert('No internet connection.'); }
    S.syncing = false; render();
}

// ========== LOGIC ==========
function balances() {
    const b = {};
    S.friends.forEach(f => b[f.id] = 0);
    S.expenses.forEach(e => {
        b[e.paidBy] = (b[e.paidBy] || 0) + e.amount;
        Object.entries(e.splitAmong).forEach(([id, a]) => b[id] = (b[id] || 0) - a);
    });
    return b;
}

function settlements() {
    const b = balances();
    const debt = [], cred = [], res = [];
    Object.entries(b).forEach(([id, v]) => {
        if (v < -0.01) debt.push({id, a: -v});
        else if (v > 0.01) cred.push({id, a: v});
    });
    let i = 0, j = 0;
    while (i < debt.length && j < cred.length) {
        const d = debt[i], c = cred[j], amt = Math.min(d.a, c.a);
        const key = d.id + '-' + c.id;
        res.push({from:d.id, to:c.id, amount:amt, key, paid: S.settlements.includes(key)});
        d.a -= amt; c.a -= amt;
        if (d.a < 0.01) i++;
        if (c.a < 0.01) j++;
    }
    return res;
}

function name(id) { return (S.friends.find(f => f.id === id) || {name:'?'}).name; }
function upi(n, a) { return 'upi://pay?pn=' + encodeURIComponent(n) + '&am=' + Math.round(a) + '&cu=INR&tn=Pachaax'; }
function customTotal() { return Object.values(S.csplits).reduce((s,v) => s + (parseFloat(v)||0), 0); }

// ========== ACTIONS ==========
window.setTab = t => { S.tab = t; render(); };
window.refreshData = () => { S.loading = true; render(); loadData(); };

window.addFriend = async () => {
    const n = S.fname.trim();
    if (!n) return;
    S.friends.push({id: Date.now().toString(), name: n});
    S.fname = ''; S.showFriend = false;
    await saveData();
};

window.addExpense = async () => {
    const amt = parseFloat(S.eamt);
    if (!S.edesc.trim() || isNaN(amt) || amt <= 0 || !S.epayer) {
        alert('Please fill all fields!'); return;
    }
    const split = {};
    if (S.esplit === 'equal') {
        const per = amt / S.friends.length;
        S.friends.forEach(f => split[f.id] = per);
    } else {
        const total = customTotal();
        if (Math.abs(total - amt) > 0.01) {
            alert('Custom split total ‚Çπ' + Math.round(total) + ' must equal ‚Çπ' + Math.round(amt));
            return;
        }
        S.friends.forEach(f => split[f.id] = parseFloat(S.csplits[f.id]) || 0);
    }
    S.expenses.push({
        id: Date.now().toString(),
        description: S.edesc.trim(),
        amount: amt, paidBy: S.epayer,
        splitAmong: split,
        date: new Date().toISOString()
    });
    S.edesc=''; S.eamt=''; S.epayer=''; S.esplit='equal'; S.csplits={};
    S.showExpense = false;
    await saveData();
};

window.delExpense = async id => {
    if (!confirm('Delete this expense?')) return;
    S.expenses = S.expenses.filter(e => e.id !== id);
    await saveData();
};

window.markPaid = async (key, paid) => {
    if (paid) S.settlements.push(key);
    else S.settlements = S.settlements.filter(s => s !== key);
    await saveData();
};

window.resetAll = async () => {
    if (!confirm('‚ö†Ô∏è Delete ALL data for everyone? This cannot be undone!')) return;
    S.friends=[]; S.expenses=[]; S.settlements=[];
    await saveData();
};

window.openFriend = () => { S.showFriend = true; render(); };
window.closeFriend = () => { S.showFriend = false; S.fname = ''; render(); };
window.openExpense = () => { S.showExpense = true; render(); };
window.closeExpense = () => { S.showExpense = false; S.edesc=''; S.eamt=''; S.epayer=''; S.esplit='equal'; S.csplits={}; render(); };
window.setSplit = t => { S.esplit = t; render(); };
window.setCustomSplit = (id, val) => { S.csplits[id] = val; render(); };
window.setFname = v => S.fname = v;
window.setEdesc = v => S.edesc = v;
window.setEamt = v => { S.eamt = v; render(); };
window.setEpayer = v => S.epayer = v;

// ========== RENDER ==========
function render() {
    document.getElementById('app').innerHTML = html();
}

function html() {
    if (S.loading) return `<div class="loading"><h2 style="color:#d97706">Loading Pachaax...</h2><p style="color:#6b7280">‚òÅÔ∏è Syncing data</p></div>`;
    
    const bal = balances();
    const sets = settlements();

    return `
    <div class="header">
        <div class="header-row">
            <div>
                <h1>üí∞ Pachaax Expenses</h1>
                <p>${S.syncing ? '‚òÅÔ∏è Syncing...' : S.lastSync ? '‚úÖ Last synced: ' + S.lastSync : 'Real-time shared tracker'}</p>
            </div>
            <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab ${S.tab==='expenses'?'active':''}" onclick="setTab('expenses')">Expenses</button>
        <button class="tab ${S.tab==='friends'?'active':''}" onclick="setTab('friends')">Friends (${S.friends.length})</button>
        <button class="tab ${S.tab==='settle'?'active':''}" onclick="setTab('settle')">Settle Up</button>
        <button class="tab ${S.tab==='thailand'?'active':''}" onclick="setTab('thailand')">Ravi's Thai üáπüá≠</button>
    </div>

    <div class="content">
        ${S.tab==='expenses' ? tabExpenses() : ''}
        ${S.tab==='friends' ? tabFriends(bal) : ''}
        ${S.tab==='settle' ? tabSettle(bal, sets) : ''}
        ${S.tab==='thailand' ? tabThailand() : ''}
    </div>

    ${S.showFriend ? modalFriend() : ''}
    ${S.showExpense ? modalExpense() : ''}

    <div class="footer">üí° Data syncs across all devices! Share the link with your group.</div>`;
}

function tabExpenses() {
    let h = `<div class="sec-header">
        <h2>All Expenses</h2>
        <button class="btn btn-primary" onclick="openExpense()" ${!S.friends.length?'disabled':''}>+ Add Expense</button>
    </div>`;
    if (!S.friends.length) return h + `<div class="empty"><p>üë• Add friends first!</p><button class="btn btn-primary" onclick="setTab('friends')">Go to Friends</button></div>`;
    if (!S.expenses.length) return h + `<div class="empty"><p>üí∏ No expenses yet!</p></div>`;
    
    h += S.expenses.map(e => {
        const tags = Object.entries(e.splitAmong)
            .filter(([,a]) => a > 0)
            .map(([id,a]) => `<span class="tag">${name(id)}: ‚Çπ${Math.round(a)}</span>`).join('');
        return `<div class="card">
            <div class="row">
                <div style="flex:1">
                    <div style="font-weight:900;font-size:16px;color:#1f2937">${e.description}</div>
                    <div style="font-size:12px;color:#6b7280;margin-top:2px">Paid by <strong style="color:#d97706">${name(e.paidBy)}</strong></div>
                </div>
                <div style="display:flex;align-items:center;gap:8px">
                    <div style="font-size:20px;font-weight:900;color:#d97706">‚Çπ${Math.round(e.amount)}</div>
                    <button class="del-btn" onclick="delExpense('${e.id}')">‚úï</button>
                </div>
            </div>
            <div class="tags">${tags}</div>
        </div>`;
    }).join('');
    return h;
}

function tabFriends(bal) {
    let h = `<div class="sec-header">
        <h2>Your Group</h2>
        <button class="btn btn-primary" onclick="openFriend()">+ Add Friend</button>
    </div>`;
    if (!S.friends.length) return h + `<div class="empty"><p>üë• Add your travel buddies!</p></div>`;
    
    h += S.friends.map(f => {
        const b = bal[f.id] || 0;
        const cls = b > 0.01 ? 'pos' : b < -0.01 ? 'neg' : 'zero';
        const txt = b > 0.01 ? `Gets back ‚Çπ${Math.round(b)}` : b < -0.01 ? `Owes ‚Çπ${Math.round(-b)}` : 'All settled ‚úì';
        return `<div class="friend-card">
            <div class="avatar">${f.name[0].toUpperCase()}</div>
            <div>
                <div style="font-weight:900;font-size:16px">${f.name}</div>
                <div class="${cls}">${txt}</div>
            </div>
        </div>`;
    }).join('');

    h += `<div style="text-align:center;margin-top:12px">
        <button class="btn btn-red btn-sm" onclick="resetAll()">üóëÔ∏è Reset All Data</button>
    </div>`;
    return h;
}

function tabSettle(bal, sets) {
    if (!S.friends.length) return `<div class="empty"><p>Add friends first!</p></div>`;
    if (!S.expenses.length) return `<div class="empty"><p>No expenses to settle yet!</p></div>`;

    let h = `<div class="bal-table">
        <div style="font-weight:900;font-size:16px;margin-bottom:10px">Current Balances</div>`;
    h += S.friends.map(f => {
        const b = bal[f.id] || 0;
        const cls = b > 0.01 ? 'pos' : b < -0.01 ? 'neg' : 'zero';
        const txt = b > 0.01 ? `+‚Çπ${Math.round(b)}` : b < -0.01 ? `-‚Çπ${Math.round(-b)}` : '‚Çπ0';
        return `<div class="bal-row"><span style="font-weight:700">${f.name}</span><span class="${cls}">${txt}</span></div>`;
    }).join('');
    h += `</div><div class="green-box"><h3>üí≥ Payments to Make</h3>`;

    if (!sets.length) {
        h += `<p style="text-align:center;color:#16a34a;font-weight:700;padding:16px">üéâ All settled up!</p>`;
    } else {
        h += sets.map(s => `
        <div class="settle-card ${s.paid?'paid':''}">
            <div class="settle-row">
                <div style="font-weight:700;font-size:14px">${name(s.from)} ‚Üí ${name(s.to)}</div>
                <div style="font-weight:900;font-size:18px;color:${s.paid?'#6b7280':'#16a34a'}">‚Çπ${Math.round(s.amount)}</div>
            </div>
            <div class="settle-btns">
                ${s.paid
                    ? `<button class="btn btn-secondary btn-sm" onclick="markPaid('${s.key}',false)" style="width:100%">‚úì Paid ‚Äî Tap to undo</button>`
                    : `<a href="${upi(name(s.to),s.amount)}" class="btn btn-purple btn-sm" style="flex:1">üí≥ Pay UPI</a>
                       <button class="btn btn-green btn-sm" onclick="markPaid('${s.key}',true)" style="flex:1">Mark Paid</button>`
                }
            </div>
        </div>`).join('');
    }
    h += `</div>`;
    return h;
}

function tabThailand() {
    return `
    <div class="thai-card">
        <h2 style="font-size:20px;font-weight:900;margin-bottom:14px">Ravi's Dream Thai Trip üáπüá≠</h2>
        <h3 style="font-weight:900;margin-bottom:10px">‚úàÔ∏è Must-Visit Places</h3>
        <ul style="list-style:none">
            <li style="padding:6px 0">üèØ <strong>Bangkok</strong> ‚Äî Grand Palace, street food</li>
            <li style="padding:6px 0">üèùÔ∏è <strong>Phuket</strong> ‚Äî Beaches & island hopping</li>
            <li style="padding:6px 0">üåÑ <strong>Chiang Mai</strong> ‚Äî Temples, night markets</li>
            <li style="padding:6px 0">üèñÔ∏è <strong>Krabi</strong> ‚Äî Limestone cliffs & clear waters</li>
        </ul>
    </div>
    <div class="thai-card">
        <h3 style="font-weight:900;margin-bottom:12px">‚úÖ Trip Checklist</h3>
        <div class="checklist">
            <label><input type="checkbox"> Check passport validity (6+ months)</label>
            <label><input type="checkbox"> Get travel insurance</label>
            <label><input type="checkbox"> Book flights & accommodation</label>
            <label><input type="checkbox"> Notify bank about travel dates</label>
            <label><input type="checkbox"> Exchange currency to Thai Baht (THB)</label>
            <label><input type="checkbox"> Pack sunscreen & medications</label>
            <label><input type="checkbox"> Download offline maps</label>
            <label><input type="checkbox"> Set up Pachaax expense tracker! üí∞</label>
        </div>
    </div>`;
}

function modalFriend() {
    return `<div class="modal-bg" onclick="closeFriend()">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Add Friend</h3>
            <input type="text" placeholder="Friend's name" value="${S.fname}"
                oninput="setFname(this.value)"
                onkeypress="if(event.key==='Enter')addFriend()" autofocus>
            <div class="modal-btns">
                <button class="btn btn-secondary" onclick="closeFriend()">Cancel</button>
                <button class="btn btn-primary" onclick="addFriend()">Add Friend</button>
            </div>
        </div>
    </div>`;
}

function modalExpense() {
    const opts = S.friends.map(f =>
        `<option value="${f.id}" ${S.epayer===f.id?'selected':''}>${f.name}</option>`).join('');
    
    const ct = customTotal();
    const expAmt = parseFloat(S.eamt) || 0;
    const ctMatch = Math.abs(ct - expAmt) < 0.01 && expAmt > 0;

    const customBox = S.esplit === 'custom' ? `
        <div class="custom-split-box">
            <div style="font-size:12px;font-weight:700;color:#6b7280;margin-bottom:8px;text-transform:uppercase">Amount per person:</div>
            ${S.friends.map(f => `
            <div class="custom-row">
                <label>${f.name}</label>
                <input type="number" placeholder="0" value="${S.csplits[f.id]||''}"
                    oninput="setCustomSplit('${f.id}',this.value)">
            </div>`).join('')}
            <div class="custom-total">
                <span style="font-size:12px;font-weight:700">Total:</span>
                <span style="font-size:14px;font-weight:900;color:${ctMatch?'#16a34a':'#ef4444'}">
                    ‚Çπ${Math.round(ct)} ${ctMatch ? '‚úÖ' : `(need ‚Çπ${Math.round(expAmt)})`}
                </span>
            </div>
        </div>` : '';

    return `<div class="modal-bg" onclick="closeExpense()">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>Add Expense</h3>
            <input type="text" placeholder="Description (e.g. Dinner, Hotel)" value="${S.edesc}"
                oninput="setEdesc(this.value)" autofocus>
            <input type="number" placeholder="Amount (‚Çπ)" value="${S.eamt}"
                oninput="setEamt(this.value)">
            <select onchange="setEpayer(this.value)">
                <option value="">Who paid?</option>
                ${opts}
            </select>
            <div class="split-toggle">
                <button class="btn btn-sm ${S.esplit==='equal'?'btn-primary':'btn-secondary'}" onclick="setSplit('equal')">‚öñÔ∏è Equal Split</button>
                <button class="btn btn-sm ${S.esplit==='custom'?'btn-primary':'btn-secondary'}" onclick="setSplit('custom')">‚úèÔ∏è Custom Split</button>
            </div>
            ${customBox}
            <div class="modal-btns">
                <button class="btn btn-secondary" onclick="closeExpense()">Cancel</button>
                <button class="btn btn-primary" onclick="addExpense()">Add Expense</button>
            </div>
        </div>
    </div>`;
}

// ========== INIT ==========
loadData();
setInterval(() => { loadData(); }, 15000);
</script>
</body>
</html>
