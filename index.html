<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>Pachaax Expenses</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 50%, #fecaca 100%); }
        .gradient-header { background: linear-gradient(90deg, #d97706 0%, #ea580c 100%); }
        .gradient-btn { background: linear-gradient(90deg, #d97706 0%, #ea580c 100%); }
        .gradient-purple { background: linear-gradient(90deg, #7c3aed 0%, #4f46e5 100%); }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const JSONBIN_BIN_ID = '679275f4acd3cb34a8c73d4e';
        const JSONBIN_API_KEY = '$2a$10$VxqPFi1LvXmGEGYHLYJ8Ju9rZJYB3.EXKXkOBM.r8qPFy1vPQXpEq';
        const API_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;
        
        const Icon = ({d, className}) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={d} />
            </svg>
        );

        function App() {
            const [activeTab, setActiveTab] = useState('expenses');
            const [showAddExpense, setShowAddExpense] = useState(false);
            const [showAddFriend, setShowAddFriend] = useState(false);
            const [friends, setFriends] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [paidSettlements, setPaidSettlements] = useState([]);
            const [loading, setLoading] = useState(true);
            const [syncing, setSyncing] = useState(false);
            const [lastSync, setLastSync] = useState(null);
            const [newFriendName, setNewFriendName] = useState('');
            const [expenseDescription, setExpenseDescription] = useState('');
            const [expenseAmount, setExpenseAmount] = useState('');
            const [expensePayer, setExpensePayer] = useState('');

            const loadData = async () => {
                try {
                    const response = await fetch(API_URL + '/latest', {
                        headers: {'X-Master-Key': JSONBIN_API_KEY}
                    });
                    if (response.ok) {
                        const data = await response.json();
                        setFriends(data.record.friends || []);
                        setExpenses(data.record.expenses || []);
                        setPaidSettlements(data.record.settlements || []);
                        setLastSync(new Date());
                    }
                } catch (error) {
                    console.error('Load error:', error);
                } finally {
                    setLoading(false);
                }
            };

            const saveData = async (newFriends, newExpenses, newSettlements) => {
                setSyncing(true);
                try {
                    const response = await fetch(API_URL, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': JSONBIN_API_KEY
                        },
                        body: JSON.stringify({
                            friends: newFriends,
                            expenses: newExpenses,
                            settlements: newSettlements
                        })
                    });
                    if (response.ok) setLastSync(new Date());
                } catch (error) {
                    console.error('Save error:', error);
                    alert('Failed to sync. Check internet connection.');
                } finally {
                    setSyncing(false);
                }
            };

            useEffect(() => {
                loadData();
                const interval = setInterval(loadData, 30000);
                return () => clearInterval(interval);
            }, []);

            const saveFriends = async (data) => {
                setFriends(data);
                await saveData(data, expenses, paidSettlements);
            };

            const saveExpenses = async (data) => {
                setExpenses(data);
                await saveData(friends, data, paidSettlements);
            };

            const saveSettlements = async (data) => {
                setPaidSettlements(data);
                await saveData(friends, expenses, data);
            };

            const addFriend = async () => {
                if (!newFriendName.trim()) return;
                await saveFriends([...friends, {id: Date.now().toString(), name: newFriendName.trim()}]);
                setNewFriendName('');
                setShowAddFriend(false);
            };

            const addExpense = async () => {
                if (!expenseDescription.trim() || !expenseAmount || !expensePayer) return;
                const amount = parseFloat(expenseAmount);
                if (isNaN(amount) || amount <= 0) return;
                
                const splitAmong = {};
                const perPerson = amount / friends.length;
                friends.forEach(f => splitAmong[f.id] = perPerson);

                await saveExpenses([...expenses, {
                    id: Date.now().toString(),
                    description: expenseDescription.trim(),
                    amount, paidBy: expensePayer, splitAmong,
                    date: new Date().toISOString()
                }]);
                
                setExpenseDescription('');
                setExpenseAmount('');
                setExpensePayer('');
                setShowAddExpense(false);
            };

            const deleteExpense = async (id) => {
                if (confirm('Delete this expense?')) {
                    await saveExpenses(expenses.filter(e => e.id !== id));
                }
            };

            const calculateBalances = () => {
                const bal = {};
                friends.forEach(f => bal[f.id] = 0);
                expenses.forEach(e => {
                    bal[e.paidBy] += e.amount;
                    Object.entries(e.splitAmong).forEach(([id, amt]) => bal[id] -= amt);
                });
                return bal;
            };

            const calculateSettlements = () => {
                const bal = calculateBalances();
                const debtors = [], creditors = [], settlements = [];
                
                Object.entries(bal).forEach(([id, b]) => {
                    if (b < -0.01) debtors.push({id, amount: -b});
                    else if (b > 0.01) creditors.push({id, amount: b});
                });

                let i = 0, j = 0;
                while (i < debtors.length && j < creditors.length) {
                    const d = debtors[i], c = creditors[j];
                    const amt = Math.min(d.amount, c.amount);
                    const key = `${d.id}-${c.id}`;
                    settlements.push({from: d.id, to: c.id, amount: amt, key, isPaid: paidSettlements.includes(key)});
                    d.amount -= amt;
                    c.amount -= amt;
                    if (d.amount < 0.01) i++;
                    if (c.amount < 0.01) j++;
                }
                return settlements;
            };

            const markPaid = async (key, paid) => {
                const updated = paid ? [...paidSettlements, key] : paidSettlements.filter(s => s !== key);
                await saveSettlements(updated);
            };

            const getName = (id) => friends.find(f => f.id === id)?.name || 'Unknown';
            const upiLink = (name, amt) => `upi://pay?pn=${encodeURIComponent(name)}&am=${Math.round(amt)}&cu=INR&tn=Pachaax`;

            if (loading) {
                return (
                    <div className="gradient-bg min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="text-yellow-800 text-xl font-bold mb-2">Loading Pachaax...</div>
                            <div className="text-sm text-gray-600">‚òÅÔ∏è Syncing data</div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="gradient-bg min-h-screen pb-20">
                    <div className="gradient-header text-white px-4 py-6 shadow-xl">
                        <div className="max-w-4xl mx-auto">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center gap-3">
                                    <Icon d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" className="w-8 h-8" />
                                    <div>
                                        <h1 className="text-2xl font-black">Pachaax Expenses</h1>
                                        <div className="text-xs text-yellow-100">
                                            {syncing ? '‚òÅÔ∏è Syncing...' : lastSync ? `‚úÖ ${lastSync.toLocaleTimeString()}` : ''}
                                        </div>
                                    </div>
                                </div>
                                <button onClick={loadData} className="bg-yellow-600 hover:bg-yellow-500 px-3 py-2 rounded-lg text-xs font-bold">
                                    üîÑ Refresh
                                </button>
                            </div>
                            <p className="text-yellow-100 text-sm mt-1">Shared tracker - real-time sync!</p>
                        </div>
                    </div>

                    <div className="sticky top-0 z-10 bg-white shadow-md">
                        <div className="max-w-4xl mx-auto flex">
                            {[
                                {key: 'expenses', label: 'Expenses'},
                                {key: 'friends', label: `Friends (${friends.length})`},
                                {key: 'settle', label: 'Settle Up'},
                                {key: 'thailand', label: "Ravi's Thai"}
                            ].map(tab => (
                                <button key={tab.key} onClick={() => setActiveTab(tab.key)}
                                    className={`flex-1 py-3 font-bold text-xs uppercase transition-all ${
                                        activeTab === tab.key 
                                            ? 'bg-yellow-100 text-yellow-900 border-b-4 border-yellow-600' 
                                            : 'text-gray-500 hover:bg-gray-50'
                                    }`}>
                                    {tab.label}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="max-w-4xl mx-auto px-4 py-4">
                        {activeTab === 'expenses' && (
                            <div>
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-2xl font-black text-gray-800">All Expenses</h2>
                                    <button onClick={() => setShowAddExpense(true)} disabled={!friends.length}
                                        className="gradient-btn text-white px-4 py-2 rounded-xl font-bold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                        + Add Expense
                                    </button>
                                </div>
                                
                                {!friends.length && (
                                    <div className="bg-white rounded-2xl p-8 text-center shadow-lg">
                                        <p className="text-gray-600 text-lg mb-3">üë• Add friends first!</p>
                                        <button onClick={() => setActiveTab('friends')} 
                                            className="gradient-btn text-white px-6 py-3 rounded-lg font-bold">
                                            Go to Friends Tab
                                        </button>
                                    </div>
                                )}

                                {friends.length > 0 && !expenses.length && (
                                    <div className="bg-white rounded-2xl p-8 text-center shadow-lg">
                                        <p className="text-gray-600 text-lg">üí∞ No expenses yet. Click "Add Expense"!</p>
                                    </div>
                                )}

                                <div className="space-y-3">
                                    {expenses.map(e => (
                                        <div key={e.id} className="bg-white rounded-xl p-4 shadow-md border-2 border-orange-100 hover:shadow-lg transition-all">
                                            <div className="flex justify-between items-start mb-2">
                                                <div className="flex-1">
                                                    <h3 className="font-black text-lg text-gray-800">{e.description}</h3>
                                                    <p className="text-sm text-gray-500">Paid by <span className="text-yellow-700 font-bold">{getName(e.paidBy)}</span></p>
                                                </div>
                                                <div className="flex items-start gap-2">
                                                    <div className="text-2xl font-black text-yellow-700">‚Çπ{e.amount.toFixed(0)}</div>
                                                    <button onClick={() => deleteExpense(e.id)}
                                                        className="text-red-500 hover:text-red-700 p-1 hover:bg-red-50 rounded">
                                                        <Icon d="M6 18L18 6M6 6l12 12" className="w-5 h-5" />
                                                    </button>
                                                </div>
                                            </div>
                                            <div className="border-t border-gray-200 pt-2 mt-2">
                                                <p className="text-xs font-bold text-gray-500 uppercase mb-2">Split among:</p>
                                                <div className="flex flex-wrap gap-2">
                                                    {Object.entries(e.splitAmong).map(([id, amt]) => (
                                                        <span key={id} className="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-bold">
                                                            {getName(id)}: ‚Çπ{amt.toFixed(0)}
                                                        </span>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'friends' && (
                            <div>
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-2xl font-black text-gray-800">Your Group</h2>
                                    <button onClick={() => setShowAddFriend(true)}
                                        className="gradient-btn text-white px-4 py-2 rounded-xl font-bold shadow-lg">
                                        + Add Friend
                                    </button>
                                </div>

                                {!friends.length && (
                                    <div className="bg-white rounded-2xl p-8 text-center shadow-lg">
                                        <p className="text-gray-600 text-lg">üë• Add your travel buddies to start!</p>
                                    </div>
                                )}

                                <div className="space-y-3">
                                    {friends.map(f => {
                                        const bal = calculateBalances()[f.id] || 0;
                                        return (
                                            <div key={f.id} className="bg-white rounded-xl p-4 shadow-md border-2 border-orange-100 flex justify-between items-center hover:shadow-lg transition-all">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-12 h-12 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center text-white font-black text-xl shadow-lg">
                                                        {f.name[0].toUpperCase()}
                                                    </div>
                                                    <div>
                                                        <h3 className="font-black text-lg text-gray-800">{f.name}</h3>
                                                        <p className={`text-sm font-bold ${
                                                            bal > 0.01 ? 'text-green-600' : 
                                                            bal < -0.01 ? 'text-red-600' : 
                                                            'text-gray-500'
                                                        }`}>
                                                            {bal > 0.01 ? `Gets back ‚Çπ${bal.toFixed(0)}` : 
                                                             bal < -0.01 ? `Owes ‚Çπ${(-bal).toFixed(0)}` : 
                                                             'All settled ‚úì'}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {activeTab === 'settle' && (
                            <div>
                                <h2 className="text-2xl font-black text-gray-800 mb-4">Settlement Plan</h2>
                                
                                {!friends.length && (
                                    <div className="bg-white rounded-2xl p-8 text-center shadow-lg">
                                        <p className="text-gray-600 text-lg">Add friends first!</p>
                                    </div>
                                )}

                                {friends.length > 0 && !expenses.length && (
                                    <div className="bg-white rounded-2xl p-8 text-center shadow-lg">
                                        <p className="text-gray-600 text-lg">No expenses to settle yet!</p>
                                    </div>
                                )}

                                {friends.length > 0 && expenses.length > 0 && (
                                    <>
                                        <div className="bg-white rounded-xl p-5 shadow-lg border-2 border-yellow-200 mb-4">
                                            <h3 className="font-black text-lg mb-3 text-gray-800 uppercase">Current Balances</h3>
                                            <div className="space-y-2">
                                                {friends.map(f => {
                                                    const bal = calculateBalances()[f.id] || 0;
                                                    return (
                                                        <div key={f.id} className="flex justify-between items-center py-2 border-b border-gray-200 last:border-0">
                                                            <span className="font-bold text-base text-gray-700">{f.name}</span>
                                                            <span className={`font-black text-lg ${
                                                                bal > 0.01 ? 'text-green-600' : 
                                                                bal < -0.01 ? 'text-red-600' : 
                                                                'text-gray-500'
                                                            }`}>
                                                                {bal > 0.01 ? `+‚Çπ${bal.toFixed(0)}` : 
                                                                 bal < -0.01 ? `-‚Çπ${(-bal).toFixed(0)}` : 
                                                                 '‚Çπ0'}
                                                            </span>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>

                                        <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-5 shadow-lg border-2 border-green-200">
                                            <h3 className="font-black text-lg mb-3 text-green-900 uppercase flex items-center gap-2">
                                                <Icon d="M5 13l4 4L19 7" className="w-6 h-6" />
                                                Payments Needed
                                            </h3>
                                            
                                            {!calculateSettlements().length ? (
                                                <p className="text-green-700 font-bold text-center py-6 text-lg">
                                                    üéâ Everyone is settled up! No payments needed.
                                                </p>
                                            ) : (
                                                <div className="space-y-3">
                                                    {calculateSettlements().map((s, i) => (
                                                        <div key={i} className={`rounded-lg p-4 shadow-md border-2 transition-all ${
                                                            s.isPaid 
                                                                ? 'bg-gray-100 border-gray-300 opacity-60' 
                                                                : 'bg-white border-green-200 hover:shadow-lg'
                                                        }`}>
                                                            <div className="flex justify-between items-center mb-3">
                                                                <div className="font-bold text-base">
                                                                    <span className="text-gray-800">{getName(s.from)}</span>
                                                                    <Icon d="M14 5l7 7m0 0l-7 7m7-7H3" className="w-4 h-4 inline mx-2 text-green-600" />
                                                                    <span className="text-gray-800">{getName(s.to)}</span>
                                                                </div>
                                                                <div className={`font-black text-xl ${s.isPaid ? 'text-gray-500' : 'text-green-700'}`}>
                                                                    ‚Çπ{s.amount.toFixed(0)}
                                                                </div>
                                                            </div>
                                                            
                                                            {s.isPaid ? (
                                                                <button onClick={() => markPaid(s.key, false)}
                                                                    className="w-full bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-bold text-sm hover:bg-gray-400 transition-all">
                                                                    ‚úì Paid (Click to undo)
                                                                </button>
                                                            ) : (
                                                                <div className="flex gap-2">
                                                                    <a href={upiLink(getName(s.to), s.amount)}
                                                                        className="flex-1 gradient-purple text-white px-4 py-2 rounded-lg font-bold text-sm text-center hover:shadow-lg transition-all">
                                                                        üí≥ Pay via UPI
                                                                    </a>
                                                                    <button onClick={() => markPaid(s.key, true)}
                                                                        className="bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-green-700 transition-all">
                                                                        Mark Paid
                                                                    </button>
                                                                </div>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    </>
                                )}
                            </div>
                        )}

                        {activeTab === 'thailand' && (
                            <div className="bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl p-6 shadow-xl border-2 border-blue-200">
                                <h2 className="text-2xl font-black text-gray-800 mb-4">Ravi's Dream Thai Trip üáπüá≠</h2>
                                
                                <div className="bg-white rounded-xl p-5 mb-4 shadow-md">
                                    <h3 className="font-black text-lg mb-3 text-gray-800">‚úàÔ∏è Must-Visit Places</h3>
                                    <ul className="space-y-2 text-base">
                                        <li className="flex items-start gap-2">
                                            <span>üèØ</span>
                                            <div><strong>Bangkok</strong> - Grand Palace, Wat Pho, street food paradise</div>
                                        </li>
                                        <li className="flex items-start gap-2">
                                            <span>üèùÔ∏è</span>
                                            <div><strong>Phuket</strong> - Beautiful beaches, island hopping adventures</div>
                                        </li>
                                        <li className="flex items-start gap-2">
                                            <span>üåÑ</span>
                                            <div><strong>Chiang Mai</strong> - Ancient temples, night markets, elephant sanctuaries</div>
                                        </li>
                                        <li className="flex items-start gap-2">
                                            <span>üèñÔ∏è</span>
                                            <div><strong>Krabi</strong> - Stunning limestone cliffs and crystal waters</div>
                                        </li>
                                    </ul>
                                </div>

                                <div className="bg-white rounded-xl p-5 shadow-md">
                                    <h3 className="font-black text-lg mb-3 text-gray-800">‚úÖ Trip Checklist</h3>
                                    <div className="space-y-2 text-base">
                                        <label className="flex items-center gap-3 hover:bg-green-50 p-2 rounded cursor-pointer transition-all">
                                            <input type="checkbox" className="w-5 h-5" />
                                            <span>Check passport validity (6+ months required)</span>
                                        </label>
                                        <label className="flex items-center gap-3 hover:bg-green-50 p-2 rounded cursor-pointer transition-all">
                                            <input type="checkbox" className="w-5 h-5" />
                                            <span>Get travel insurance</span>
                                        </label>
                                        <label className="flex items-center gap-3 hover:bg-blue-50 p-2 rounded cursor-pointer transition-all">
                                            <input type="checkbox" className="w-5 h-5" />
                                            <span>Book flights and accommodation</span>
                                        </label>
                                        <label className="flex items-center gap-3 hover:bg-blue-50 p-2 rounded cursor-pointer transition-all">
                                            <input type="checkbox" className="w-5 h-5" />
                                            <span>Notify bank about travel dates</span>
                                        </label>
                                        <label className="flex items-center gap-3 hover:bg-purple-50 p-2 rounded cursor-pointer transition-all">
                                            <input type="checkbox" className="w-5 h-5" />
                                            <span>Exchange currency to Thai Baht (THB)</span>
                                        </label>
                                        <label className="flex items-center gap-3 hover:bg-purple-50 p-2 rounded cursor-pointer transition-all">
                                            <input type="checkbox" className="w-5 h-5" />
                                            <span>Pack sunscreen, medications & light clothing</span>
                                        </label>
                                        <label className="flex items-center gap-3 hover:bg-orange-50 p-2 rounded cursor-pointer transition-all">
                                            <input type="checkbox" className="w-5 h-5" />
                                            <span>Download offline maps (Google Maps, Maps.me)</span>
                                        </label>
                                        <label className="flex items-center gap-3 hover:bg-orange-50 p-2 rounded cursor-pointer transition-all">
                                            <input type="checkbox" className="w-5 h-5" />
                                            <span>Set up Pachaax expense tracker! üí∞</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {showAddFriend && (
                        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50" onClick={() => setShowAddFriend(false)}>
                            <div className="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h3 className="text-2xl font-black mb-4 text-gray-800">Add Friend</h3>
                                <input type="text" placeholder="Friend's name" value={newFriendName}
                                    onChange={e => setNewFriendName(e.target.value)}
                                    onKeyPress={e => e.key === 'Enter' && addFriend()}
                                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg mb-4 text-lg focus:border-yellow-500 focus:outline-none" 
                                    autoFocus />
                                <div className="flex gap-3">
                                    <button onClick={() => {setShowAddFriend(false); setNewFriendName('');}}
                                        className="flex-1 bg-gray-200 text-gray-700 px-4 py-3 rounded-lg font-bold hover:bg-gray-300 transition-all">
                                        Cancel
                                    </button>
                                    <button onClick={addFriend} disabled={!newFriendName.trim()}
                                        className="flex-1 gradient-btn text-white px-4 py-3 rounded-lg font-bold disabled:opacity-50 shadow-lg hover:shadow-xl transition-all">
                                        Add Friend
                                    </button>
                                </div>
                            </div>
                        </div>