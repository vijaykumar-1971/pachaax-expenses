<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pachaax Expenses</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#fff7ed;min-height:100vh;padding-bottom:60px}
.hdr{background:linear-gradient(90deg,#d97706,#ea580c);color:white;padding:14px 16px}
.hdr h1{font-size:20px;font-weight:900}
.hdr p{font-size:11px;color:#fef3c7;margin-top:2px}
.hdr-row{display:flex;justify-content:space-between;align-items:center}
.tabs{display:flex;background:white;box-shadow:0 2px 4px rgba(0,0,0,0.1);position:sticky;top:0;z-index:100;overflow-x:auto}
.tab{flex:1;min-width:70px;padding:11px 4px;font-size:10px;font-weight:700;text-transform:uppercase;background:none;border:none;cursor:pointer;color:#6b7280;border-bottom:3px solid transparent;white-space:nowrap}
.tab.on{color:#92400e;background:#fef3c7;border-bottom:3px solid #d97706}
.wrap{max-width:600px;margin:0 auto;padding:14px}
.card{background:white;border-radius:12px;padding:14px;margin-bottom:10px;box-shadow:0 2px 6px rgba(0,0,0,0.07);border:2px solid #fed7aa}
.row{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
.tags{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px;padding-top:8px;border-top:1px solid #f3f4f6}
.tag{background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:20px;font-size:11px;font-weight:700}
button{cursor:pointer;border:none;font-family:inherit}
.btn{padding:10px 14px;border-radius:10px;font-weight:700;font-size:13px}
.primary{background:linear-gradient(90deg,#d97706,#ea580c);color:white}
.primary:disabled{opacity:0.5;cursor:not-allowed}
.secondary{background:#e5e7eb;color:#374151}
.danger{background:#ef4444;color:white}
.green{background:#16a34a;color:white}
.purple{background:linear-gradient(90deg,#7c3aed,#4f46e5);color:white;text-decoration:none;display:inline-block;text-align:center}
.sm{padding:7px 11px;font-size:12px;border-radius:8px}
.shd{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.shd h2{font-size:19px;font-weight:900;color:#1f2937}
.empty{background:white;border-radius:12px;padding:36px;text-align:center}
.empty p{color:#6b7280;margin-bottom:14px}
.av{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,#fbbf24,#f97316);color:white;font-size:17px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;padding:16px;z-index:999}
.modal{background:white;border-radius:18px;padding:22px;width:100%;max-width:400px;max-height:92vh;overflow-y:auto}
.modal h3{font-size:18px;font-weight:900;margin-bottom:14px;color:#1f2937}
.f{width:100%;padding:11px;border:2px solid #e5e7eb;border-radius:9px;font-size:14px;margin-bottom:9px;outline:none;font-family:inherit;background:white;display:block}
.f:focus{border-color:#d97706}
.mbtns{display:flex;gap:8px;margin-top:8px}
.mbtns button{flex:1;padding:11px}
.stgl{display:flex;gap:8px;margin-bottom:9px}
.stgl button{flex:1;padding:8px;font-size:12px}
.cbox{background:#f9fafb;border-radius:9px;padding:11px;margin-bottom:9px;border:2px solid #e5e7eb}
.crow{display:flex;align-items:center;gap:8px;margin-bottom:7px}
.crow span{flex:1;font-weight:600;font-size:13px}
.ci{width:95px;padding:8px;font-size:13px;border:2px solid #e5e7eb;border-radius:7px;outline:none;font-family:inherit}
.ci:focus{border-color:#d97706}
.ctot{display:flex;justify-content:space-between;padding-top:7px;margin-top:3px;border-top:1px solid #e5e7eb;font-size:12px}
.btbl{background:white;border-radius:11px;padding:14px;margin-bottom:12px;box-shadow:0 2px 6px rgba(0,0,0,0.07)}
.brow{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f3f4f6}
.brow:last-child{border:none}
.gbox{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border-radius:12px;padding:14px;border:2px solid #86efac}
.gbox h3{font-weight:900;font-size:14px;color:#14532d;margin-bottom:10px;text-transform:uppercase}
.sc{background:white;border-radius:9px;padding:12px;margin-bottom:9px;box-shadow:0 1px 4px rgba(0,0,0,0.08)}
.sc.paid{background:#f3f4f6;opacity:0.6}
.srow{display:flex;justify-content:space-between;align-items:center;margin-bottom:9px}
.sbtns{display:flex;gap:7px}
.tc{background:linear-gradient(135deg,#eff6ff,#f5f3ff);border-radius:12px;padding:18px;margin-bottom:10px;border:2px solid #ddd6fe}
.cl label{display:flex;align-items:center;gap:9px;padding:6px;border-radius:7px;cursor:pointer;font-size:13px}
.cl label:hover{background:#f0fdf4}
.cl input[type=checkbox]{width:16px;height:16px;flex-shrink:0}
.foot{position:fixed;bottom:0;left:0;right:0;background:#78350f;color:#fef3c7;padding:7px;text-align:center;font-size:11px}
.dbtn{background:none;color:#ef4444;padding:3px;font-size:16px}
.ebtn{background:none;color:#d97706;padding:3px;font-size:14px}
.rbtn{background:rgba(0,0,0,0.2);color:white;padding:6px 10px;border-radius:7px;font-size:11px;font-weight:700}
.pos{color:#16a34a;font-weight:700;font-size:12px}
.neg{color:#ef4444;font-weight:700;font-size:12px}
.zero{color:#6b7280;font-weight:700;font-size:12px}
.fc{background:white;border-radius:12px;padding:12px 14px;margin-bottom:9px;display:flex;align-items:center;gap:10px;box-shadow:0 2px 6px rgba(0,0,0,0.07);border:2px solid #fed7aa}
.toast{position:fixed;top:14px;left:50%;transform:translateX(-50%);background:#1f2937;color:white;padding:9px 18px;border-radius:9px;font-size:12px;font-weight:600;z-index:9999;opacity:0;transition:opacity 0.3s;pointer-events:none}
.toast.show{opacity:1}
.trip-screen{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:22px;background:linear-gradient(135deg,#fff7ed,#fef3c7)}
.trip-box{background:white;border-radius:18px;padding:22px;width:100%;max-width:380px;box-shadow:0 4px 20px rgba(0,0,0,0.1)}
.trip-item{background:#fff7ed;border:2px solid #fed7aa;border-radius:10px;padding:11px 13px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;margin-bottom:7px}
.trip-item:hover{background:#fef3c7}
.lbl{font-size:11px;font-weight:700;color:#6b7280;display:block;margin-bottom:4px;text-transform:uppercase}
</style>
</head>
<body>
<div id="root"></div>
<div class="toast" id="toast"></div>

<script>
// ============ CONFIG ============
const FB = 'https://pachaax-expenses-default-rtdb.firebaseio.com/trips';

// ============ STATE ============
let tripId   = localStorage.getItem('px-trip') || '';
let db       = { friends:[], expenses:[], settlements:[], meta:{} };
let trips    = [];
let tab      = 'expenses';
let syncing  = false;
let lastSync = '';
let modal    = null; // null | 'friend' | 'expense' | 'trip'
let editId   = null;
// form fields
let fname='', edesc='', eamt='', epayer='', esplit='equal', csplits={};

// ============ TOAST ============
function toast(msg) {
  var t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

// ============ FIREBASE ============
function url(path) { return FB+'/'+path+'.json'; }

async function fbGet(path) {
  var r = await fetch(url(path));
  return r.ok ? r.json() : null;
}

async function fbSet(path, data) {
  var r = await fetch(url(path), {
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(data)
  });
  return r.ok;
}

// ============ LOAD / SAVE ============
async function loadTrip() {
  try {
    var d = await fbGet(tripId);
    if (d) {
      db.friends     = d.friends     || [];
      db.expenses    = d.expenses    || [];
      db.settlements = d.settlements || [];
      db.meta        = d.meta        || {};
    } else {
      db = {friends:[],expenses:[],settlements:[],meta:{}};
    }
    lastSync = new Date().toLocaleTimeString();
  } catch(e) { toast('âš ï¸ Load failed'); }
  render();
}

async function saveTrip() {
  syncing=true; updateSync();
  try {
    var ok = await fbSet(tripId, db);
    if (ok) { lastSync=new Date().toLocaleTimeString(); toast('âœ… Saved!'); }
    else toast('âš ï¸ Save failed');
  } catch(e) { toast('âš ï¸ No internet'); }
  syncing=false; updateSync();
}

async function loadTrips() {
  try {
    var r = await fetch(FB+'.json?shallow=true');
    if (!r.ok) { trips=[]; render(); return; }
    var d = await r.json();
    if (!d) { trips=[]; render(); return; }
    var keys = Object.keys(d);
    var list = await Promise.all(keys.map(async k => {
      try {
        var m = await fbGet(k+'/meta');
        return {id:k, name:(m&&m.name)||k, date:(m&&m.date)||''};
      } catch(e) { return {id:k,name:k,date:''}; }
    }));
    trips = list.sort((a,b)=>b.date.localeCompare(a.date));
  } catch(e) { trips=[]; }
  render();
}

function updateSync() {
  var el=document.getElementById('sync');
  if(el) el.textContent = syncing?'â˜ï¸ Syncing...': lastSync?'âœ… '+lastSync:'';
}

// ============ AUTO REFRESH ============
setInterval(async()=>{
  if(!tripId||modal||syncing) return;
  try {
    var d=await fbGet(tripId);
    if(d){
      db.friends=d.friends||[]; db.expenses=d.expenses||[];
      db.settlements=d.settlements||[]; db.meta=d.meta||{};
      lastSync=new Date().toLocaleTimeString();
      render();
    }
  } catch(e){}
},10000);

// ============ CALC ============
function balances() {
  var b={};
  db.friends.forEach(f=>b[f.id]=0);
  db.expenses.forEach(e=>{
    b[e.paidBy]=(b[e.paidBy]||0)+e.amount;
    Object.entries(e.splitAmong).forEach(([id,a])=>b[id]=(b[id]||0)-a);
  });
  return b;
}

function settlements() {
  var b=balances(), debt=[], cred=[], res=[];
  Object.entries(b).forEach(([id,v])=>{
    if(v<-0.01) debt.push({id,a:-v});
    else if(v>0.01) cred.push({id,a:v});
  });
  var i=0,j=0;
  while(i<debt.length&&j<cred.length){
    var d=debt[i],c=cred[j],amt=Math.min(d.a,c.a),key=d.id+'-'+c.id;
    res.push({from:d.id,to:c.id,amount:amt,key,paid:db.settlements.includes(key)});
    d.a-=amt; c.a-=amt;
    if(d.a<0.01)i++; if(c.a<0.01)j++;
  }
  return res;
}

function gname(id){ return (db.friends.find(f=>f.id===id)||{name:'?'}).name; }
function upi(n,a){ return 'upi://pay?pn='+encodeURIComponent(n)+'&am='+Math.round(a)+'&cu=INR&tn=Pachaax'; }
function ctotal(){ return Object.values(csplits).reduce((s,v)=>s+(parseFloat(v)||0),0); }

// ============ ACTIONS ============
async function doAddFriend() {
  var n=(document.getElementById('if')||{value:''}).value.trim();
  if(!n){toast('Enter a name!');return;}
  db.friends.push({id:'f'+Date.now(),name:n});
  fname=''; modal=null; render(); await saveTrip();
}

async function doAddExpense() {
  var desc=(document.getElementById('ied')||{value:''}).value.trim();
  var amt=parseFloat((document.getElementById('iea')||{value:''}).value);
  var payer=(document.getElementById('iep')||{value:''}).value;
  if(!desc||isNaN(amt)||amt<=0||!payer){toast('Fill all fields!');return;}
  var split={};
  if(esplit==='equal'){
    var per=amt/db.friends.length;
    db.friends.forEach(f=>split[f.id]=per);
  } else {
    db.friends.forEach(f=>{
      var el=document.getElementById('cs'+f.id);
      if(el) csplits[f.id]=el.value;
    });
    var tot=ctotal();
    if(Math.abs(tot-amt)>0.01){toast('Split â‚¹'+Math.round(tot)+' â‰  â‚¹'+Math.round(amt));return;}
    db.friends.forEach(f=>split[f.id]=parseFloat(csplits[f.id])||0);
  }
  if(editId){
    var idx=db.expenses.findIndex(e=>e.id===editId);
    if(idx!==-1) db.expenses[idx]={...db.expenses[idx],description:desc,amount:amt,paidBy:payer,splitAmong:split};
  } else {
    db.expenses.push({id:'e'+Date.now(),description:desc,amount:amt,paidBy:payer,splitAmong:split,date:new Date().toISOString()});
  }
  modal=null; editId=null; edesc=''; eamt=''; epayer=''; esplit='equal'; csplits={};
  render(); await saveTrip();
}

async function doDelExpense(id) {
  if(!confirm('Delete this expense?'))return;
  db.expenses=db.expenses.filter(e=>e.id!==id);
  render(); await saveTrip();
}

function doEditExpense(id) {
  var e=db.expenses.find(x=>x.id===id);
  if(!e)return;
  editId=id; edesc=e.description; eamt=String(e.amount); epayer=e.paidBy;
  var vals=Object.values(e.splitAmong);
  var eq=vals.length>1&&vals.every(v=>Math.abs(v-vals[0])<0.01);
  esplit=eq?'equal':'custom';
  csplits=eq?{}:Object.fromEntries(Object.entries(e.splitAmong).map(([k,v])=>[k,String(v)]));
  modal='expense'; render();
  setTimeout(()=>{var el=document.getElementById('ied');if(el){el.focus();el.setSelectionRange(el.value.length,el.value.length);}if(!eq)calcTotal();},100);
}

async function doMarkPaid(key,paid) {
  if(paid) db.settlements.push(key);
  else db.settlements=db.settlements.filter(s=>s!==key);
  render(); await saveTrip();
}

async function doReset() {
  if(!confirm('Delete ALL data for everyone?'))return;
  db={friends:[],expenses:[],settlements:[],meta:{}};
  render(); await saveTrip();
}

async function doCreateTrip() {
  var n=(document.getElementById('itn')||{value:''}).value.trim();
  var dt=(document.getElementById('itd')||{value:''}).value;
  if(!n){toast('Enter a trip name!');return;}
  tripId=n.toUpperCase().replace(/\s+/g,'-').replace(/[^A-Z0-9-]/g,'');
  localStorage.setItem('px-trip',tripId);
  db={friends:[],expenses:[],settlements:[],meta:{name:n,date:dt,created:new Date().toISOString()}};
  modal=null; render();
  await fbSet(tripId+'/meta',db.meta);
}

function doSelectTrip(id) {
  tripId=id; localStorage.setItem('px-trip',id);
  db={friends:[],expenses:[],settlements:[],meta:{}}; modal=null;
  render(); loadTrip();
}

function doSwitchTrip() {
  tripId=''; localStorage.removeItem('px-trip');
  db={friends:[],expenses:[],settlements:[],meta:{}};
  trips=[]; render(); loadTrips();
}

function calcTotal() {
  var tot=0;
  db.friends.forEach(f=>{var el=document.getElementById('cs'+f.id);if(el)tot+=parseFloat(el.value)||0;});
  var ea=parseFloat((document.getElementById('iea')||{value:'0'}).value)||0;
  var match=ea>0&&Math.abs(tot-ea)<0.01;
  var el=document.getElementById('ctot');
  if(el){el.textContent='â‚¹'+Math.round(tot)+(match?' âœ…':ea>0?' (need â‚¹'+Math.round(ea)+')':'');el.style.color=match?'#16a34a':'#ef4444';}
}

function doSetSplit(t) {
  // save current inputs before re-render
  db.friends.forEach(f=>{var el=document.getElementById('cs'+f.id);if(el)csplits[f.id]=el.value;});
  var ded=document.getElementById('ied'); if(ded)edesc=ded.value;
  var dea=document.getElementById('iea'); if(dea)eamt=dea.value;
  var dep=document.getElementById('iep'); if(dep)epayer=dep.value;
  esplit=t; render();
  setTimeout(()=>{if(t==='custom')calcTotal();},50);
}

// ============ RENDER ============
function render() {
  var root=document.getElementById('root');
  if(!root)return;
  if(!tripId){root.innerHTML=tripScreen();return;}
  var bal=balances(), sets=settlements();
  var meta=db.meta||{};
  var tripLabel=meta.name||tripId;
  var tripDate=meta.date?new Date(meta.date).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}):'';

  var body='';
  if(tab==='expenses') body=tabExp(bal);
  else if(tab==='friends') body=tabFr(bal);
  else if(tab==='settle') body=tabSet(bal,sets);
  else if(tab==='thailand') body=tabTh();

  root.innerHTML=`
  <div class="hdr">
    <div class="hdr-row">
      <div>
        <h1>ğŸ’° Pachaax Expenses</h1>
        <p id="sync">${syncing?'â˜ï¸ Syncing...':lastSync?'âœ… '+lastSync:''}</p>
        ${tripLabel?`<p style="font-size:11px;color:#fef3c7;font-weight:700;margin-top:1px">âœˆï¸ ${tripLabel}${tripDate?' Â· ğŸ“… '+tripDate:''}</p>`:''}
      </div>
      <div style="display:flex;gap:5px">
        <button class="rbtn" onclick="loadTrip()">ğŸ”„</button>
        <button class="rbtn" onclick="doSwitchTrip()">ğŸ”€</button>
      </div>
    </div>
  </div>
  <div class="tabs">
    <button class="tab ${tab==='expenses'?'on':''}" onclick="tab='expenses';render()">Expenses</button>
    <button class="tab ${tab==='friends'?'on':''}" onclick="tab='friends';render()">Friends (${db.friends.length})</button>
    <button class="tab ${tab==='settle'?'on':''}" onclick="tab='settle';render()">Settle Up</button>
    <button class="tab ${tab==='thailand'?'on':''}" onclick="tab='thailand';render()">Ravi's Thai ğŸ‡¹ğŸ‡­</button>
  </div>
  <div class="wrap">${body}</div>
  ${modal==='friend'?mFriend():modal==='expense'?mExpense():''}
  <div class="foot">ğŸ’¡ ${tripId} Â· Syncs every 10s across all devices</div>`;
}

// ============ TABS ============
function tabExp(bal) {
  var total=db.expenses.reduce((s,e)=>s+e.amount,0);
  var h=`<div class="shd"><h2>All Expenses</h2>
    <button class="btn primary sm" onclick="editId=null;edesc='';eamt='';epayer='';esplit='equal';csplits={};modal='expense';render();setTimeout(()=>{var e=document.getElementById('ied');if(e)e.focus();},100)" ${!db.friends.length?'disabled':''}>+ Add</button>
  </div>`;
  if(!db.friends.length) return h+`<div class="empty"><p>ğŸ‘¥ Add friends first!</p><button class="btn primary" onclick="tab='friends';render()">Go to Friends</button></div>`;
  if(!db.expenses.length) return h+`<div class="empty"><p>ğŸ’¸ No expenses yet!</p></div>`;
  h+=`<div style="background:linear-gradient(90deg,#d97706,#ea580c);color:white;border-radius:12px;padding:12px 14px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center">
    <div>
      <div style="font-size:11px;font-weight:700;opacity:0.85">TOTAL EXPENSES</div>
      <div style="font-size:11px;opacity:0.7">${db.expenses.length} expense${db.expenses.length!==1?'s':''} Â· ${db.friends.length} people</div>
    </div>
    <div style="font-size:24px;font-weight:900">â‚¹${Math.round(total).toLocaleString()}</div>
  </div>`;
  h+=db.expenses.map(e=>{
    var tags=Object.entries(e.splitAmong).filter(([,a])=>a>0).map(([id,a])=>`<span class="tag">${gname(id)}: â‚¹${Math.round(a)}</span>`).join('');
    return `<div class="card">
      <div class="row">
        <div style="flex:1;min-width:0">
          <div style="font-weight:900;font-size:15px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${e.description}</div>
          <div style="font-size:11px;color:#6b7280;margin-top:2px">Paid by <strong style="color:#d97706">${gname(e.paidBy)}</strong></div>
        </div>
        <div style="display:flex;align-items:center;gap:5px;flex-shrink:0">
          <div style="font-size:18px;font-weight:900;color:#d97706">â‚¹${Math.round(e.amount)}</div>
          <button class="ebtn" onclick="doEditExpense('${e.id}')">âœï¸</button>
          <button class="dbtn" onclick="doDelExpense('${e.id}')">âœ•</button>
        </div>
      </div>
      <div class="tags">${tags}</div>
    </div>`;
  }).join('');
  return h;
}

function tabFr(bal) {
  var h=`<div class="shd"><h2>Your Group</h2>
    <button class="btn primary sm" onclick="fname='';modal='friend';render();setTimeout(()=>{var e=document.getElementById('if');if(e)e.focus();},100)">+ Add</button>
  </div>`;
  if(!db.friends.length) return h+`<div class="empty"><p>ğŸ‘¥ Add your travel buddies!</p></div>`;
  h+=db.friends.map(f=>{
    var b=bal[f.id]||0,cls=b>0.01?'pos':b<-0.01?'neg':'zero';
    var txt=b>0.01?`Gets back â‚¹${Math.round(b)}`:b<-0.01?`Owes â‚¹${Math.round(-b)}`:'All settled âœ“';
    return `<div class="fc">
      <div class="av">${f.name[0].toUpperCase()}</div>
      <div><div style="font-weight:900;font-size:15px">${f.name}</div><div class="${cls}">${txt}</div></div>
    </div>`;
  }).join('');
  h+=`<div style="text-align:center;margin-top:10px"><button class="btn danger sm" onclick="doReset()">ğŸ—‘ï¸ Reset All Data</button></div>`;
  return h;
}

function tabSet(bal,sets) {
  if(!db.friends.length) return `<div class="empty"><p>Add friends first!</p></div>`;
  if(!db.expenses.length) return `<div class="empty"><p>No expenses yet!</p></div>`;
  var h=`<div class="btbl"><div style="font-weight:900;font-size:15px;margin-bottom:10px">Current Balances</div>`;
  h+=db.friends.map(f=>{
    var b=bal[f.id]||0,cls=b>0.01?'pos':b<-0.01?'neg':'zero';
    var txt=b>0.01?`+â‚¹${Math.round(b)}`:b<-0.01?`-â‚¹${Math.round(-b)}`:'â‚¹0';
    return `<div class="brow"><span style="font-weight:700">${f.name}</span><span class="${cls}">${txt}</span></div>`;
  }).join('');
  h+=`</div><div class="gbox"><h3>ğŸ’³ Payments to Make</h3>`;
  if(!sets.length) h+=`<p style="text-align:center;color:#16a34a;font-weight:700;padding:14px">ğŸ‰ All settled up!</p>`;
  else h+=sets.map(s=>`
  <div class="sc ${s.paid?'paid':''}">
    <div class="srow">
      <div style="font-weight:700;font-size:13px">${gname(s.from)} â†’ ${gname(s.to)}</div>
      <div style="font-weight:900;font-size:17px;color:${s.paid?'#6b7280':'#16a34a'}">â‚¹${Math.round(s.amount)}</div>
    </div>
    <div class="sbtns">
      ${s.paid
        ?`<button class="btn secondary sm" onclick="doMarkPaid('${s.key}',false)" style="width:100%">âœ“ Paid â€” Undo</button>`
        :`<a href="${upi(gname(s.to),s.amount)}" class="btn purple sm" style="flex:1">ğŸ’³ Pay UPI</a>
          <button class="btn green sm" onclick="doMarkPaid('${s.key}',true)" style="flex:1">Mark Paid</button>`
      }
    </div>
  </div>`).join('');
  return h+`</div>`;
}

function tabTh(){
  return `
  <div class="tc"><h2 style="font-size:19px;font-weight:900;margin-bottom:12px">Ravi's Dream Thai ğŸ‡¹ğŸ‡­</h2>
    <h3 style="font-weight:900;margin-bottom:8px;font-size:14px">âœˆï¸ Must-Visit</h3>
    <ul style="list-style:none;font-size:13px">
      <li style="padding:5px 0">ğŸ¯ <strong>Bangkok</strong> â€” Grand Palace, street food</li>
      <li style="padding:5px 0">ğŸï¸ <strong>Phuket</strong> â€” Beaches & islands</li>
      <li style="padding:5px 0">ğŸŒ„ <strong>Chiang Mai</strong> â€” Temples, night markets</li>
      <li style="padding:5px 0">ğŸ–ï¸ <strong>Krabi</strong> â€” Cliffs & clear waters</li>
    </ul>
  </div>
  <div class="tc"><h3 style="font-weight:900;margin-bottom:10px;font-size:14px">âœ… Trip Checklist</h3>
    <div class="cl">
      <label><input type="checkbox"> Check passport (6+ months)</label>
      <label><input type="checkbox"> Get travel insurance</label>
      <label><input type="checkbox"> Book flights & hotel</label>
      <label><input type="checkbox"> Notify bank</label>
      <label><input type="checkbox"> Exchange to Thai Baht</label>
      <label><input type="checkbox"> Pack sunscreen & meds</label>
      <label><input type="checkbox"> Download offline maps</label>
      <label><input type="checkbox"> Set up Pachaax ğŸ’°</label>
    </div>
  </div>`;
}

// ============ TRIP SCREEN ============
function tripScreen(){
  var today=new Date().toISOString().split('T')[0];
  var list=trips.length?trips.map(t=>`
    <div class="trip-item" onclick="doSelectTrip('${t.id}')">
      <div>
        <div style="font-weight:900;font-size:13px;color:#92400e">${t.name}</div>
        <div style="font-size:11px;color:#6b7280">ğŸ·ï¸ ${t.id}${t.date?' Â· ğŸ“… '+new Date(t.date).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}):''}</div>
      </div>
      <span style="font-size:18px;color:#d97706">â†’</span>
    </div>`).join('')
    :`<p style="text-align:center;color:#9ca3af;font-size:12px;margin-top:12px">No existing trips found</p>`;

  return `<div class="trip-screen">
    <div style="font-size:48px;margin-bottom:10px">ğŸ’°</div>
    <h1 style="font-size:24px;font-weight:900;color:#92400e;margin-bottom:4px">Pachaax Expenses</h1>
    <p style="color:#6b7280;font-size:12px;margin-bottom:20px;text-align:center">Create or join a trip to get started</p>
    <div class="trip-box">
      <div style="font-weight:900;font-size:12px;color:#374151;margin-bottom:8px;text-transform:uppercase">âœ¨ Create New Trip</div>
      <span class="lbl">Trip Name</span>
      <input id="itn" class="f" type="text" placeholder="e.g. Thailand 2025, Goa Trip" onkeydown="if(event.key==='Enter')doCreateTrip()">
      <span class="lbl">Trip Date</span>
      <input id="itd" class="f" type="date" value="${today}">
      <button class="btn primary" onclick="doCreateTrip()" style="width:100%;padding:12px;font-size:14px;margin-top:2px">ğŸš€ Create Trip</button>
      ${trips.length?`<div style="margin-top:18px;font-weight:900;font-size:12px;color:#374151;margin-bottom:8px;text-transform:uppercase">ğŸ“‹ Join Existing Trip</div>${list}`:''}
      ${!trips.length?`<p style="text-align:center;color:#9ca3af;font-size:11px;margin-top:12px">Loading trips...</p>`:''}
    </div>
  </div>`;
}

// ============ MODALS ============
function mFriend(){
  return `<div class="overlay" onclick="modal=null;render()">
    <div class="modal" onclick="event.stopPropagation()">
      <h3>ğŸ‘¤ Add Friend</h3>
      <input id="if" class="f" type="text" placeholder="Friend's name" autocomplete="off"
        onkeydown="if(event.key==='Enter')doAddFriend()">
      <div class="mbtns">
        <button class="btn secondary" onclick="modal=null;render()">Cancel</button>
        <button class="btn primary" onclick="doAddFriend()">Add Friend</button>
      </div>
    </div>
  </div>`;
}

function mExpense(){
  var opts=db.friends.map(f=>`<option value="${f.id}" ${epayer===f.id?'selected':''}>${f.name}</option>`).join('');
  var isEdit=!!editId;
  var cbox=esplit==='custom'?`
    <div class="cbox">
      <div style="font-size:11px;font-weight:700;color:#6b7280;margin-bottom:7px">AMOUNT PER PERSON:</div>
      ${db.friends.map(f=>`
      <div class="crow">
        <span>${f.name}</span>
        <input id="cs${f.id}" class="ci" type="number" inputmode="decimal" placeholder="0"
          value="${csplits[f.id]||''}" oninput="calcTotal()">
      </div>`).join('')}
      <div class="ctot">
        <span style="font-weight:700">Total:</span>
        <span id="ctot" style="font-weight:900;color:#ef4444">â‚¹0</span>
      </div>
    </div>`:'';
  return `<div class="overlay" onclick="modal=null;editId=null;render()">
    <div class="modal" onclick="event.stopPropagation()">
      <h3>${isEdit?'âœï¸ Edit Expense':'ğŸ’¸ Add Expense'}</h3>
      <span class="lbl">Description</span>
      <input id="ied" class="f" type="text" placeholder="e.g. Dinner, Hotel" autocomplete="off" value="${edesc}">
      <span class="lbl">Amount (â‚¹)</span>
      <input id="iea" class="f" type="number" inputmode="decimal" placeholder="0" value="${eamt}" oninput="calcTotal()">
      <span class="lbl">Who Paid?</span>
      <select id="iep" class="f"><option value="">Select person</option>${opts}</select>
      <span class="lbl">Split Type</span>
      <div class="stgl">
        <button class="btn sm ${esplit==='equal'?'primary':'secondary'}" onclick="doSetSplit('equal')">âš–ï¸ Equal</button>
        <button class="btn sm ${esplit==='custom'?'primary':'secondary'}" onclick="doSetSplit('custom')">âœï¸ Custom</button>
      </div>
      ${cbox}
      <div class="mbtns">
        <button class="btn secondary" onclick="modal=null;editId=null;render()">Cancel</button>
        <button class="btn primary" onclick="doAddExpense()">${isEdit?'ğŸ’¾ Save':'â• Add Expense'}</button>
      </div>
    </div>
  </div>`;
}

// ============ INIT ============
render();
if(tripId) loadTrip();
else loadTrips();
</script>
</body>
</html>
